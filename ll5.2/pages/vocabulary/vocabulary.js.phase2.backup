// pages/vocabulary/vocabulary.js - æ™ºèƒ½å­¦ä¹ æµç¨‹
import learningDataManager from '../../utils/learning-data-manager.js'
import smartLearningPlanner from '../../utils/smart-learning-planner.js'

Page({
  __loadStartTime: Date.now(),
  data: {
    // é¡µé¢çŠ¶æ€ï¼šloading, learning, completed, already_completed
    pageState: 'loading',
    themeClass: '',

    // å¿«é€Ÿè®¾ç½®
    showQuickSetup: false,

    // å­¦ä¹ æ•°æ®
    dailyGoal: 50,
    learnedCount: 0,
    progress: 0,
    currentWord: null,
    wordsToLearn: [],
    currentIndex: 0,

    // å®Œæˆé¡µé¢æ•°æ®
    sessionStats: {
      learnedCount: 0,
      timeSpent: 0,
      accuracy: 0
    },
    showTestSuggestion: false,
    testSuggestionMessage: '',

    // å·²å®Œæˆé¡µé¢æ•°æ®
    streak: 0,
    todayLearned: 0,
    totalLearned: 0,
    accuracy: 0,

    // AIæç¤º
    showAIHint: false,
    aiHintMessage: '',
    aiHintAction: '',

    // è¡Œä¸ºç›‘æ§
    hesitationTimer: null,
    errorCount: 0
  },

  onLoad() {
    console.log('ğŸ“– [è¯æ±‡å­¦ä¹ ] é¡µé¢åŠ è½½')
    this.initializePage()
  },

  onReady() {
    // æ€§èƒ½è·Ÿè¸ª
    const app = getApp()
    if (app.globalData && app.globalData.perfTest) {
      const loadTime = Date.now() - this.__loadStartTime
      app.globalData.perfTest.recordPagePerformance('vocabulary', { loadTime })
    }
  },

  onUnload() {
    // æ¸…ç†å®šæ—¶å™¨
    if (this.data.hesitationTimer) {
      clearTimeout(this.data.hesitationTimer)
    }
  },

  /**
   * åˆå§‹åŒ–é¡µé¢
   */
  async initializePage() {
    try {
      // è·å–ä¸»é¢˜
      const theme = wx.getStorageSync('theme') || 'light'
      this.setData({
        themeClass: theme === 'dark' ? 'theme-dark' : ''
      })

      // ä½¿ç”¨æ™ºèƒ½è§„åˆ’å™¨åˆ¤æ–­çŠ¶æ€
      const state = smartLearningPlanner.decideLearningState()
      console.log('ğŸ” [è¯æ±‡å­¦ä¹ ] å­¦ä¹ çŠ¶æ€:', state)

      // æ ¹æ®çŠ¶æ€æ‰§è¡Œç›¸åº”æ“ä½œ
      switch (state.action) {
        case 'show_setup':
          // é¦–æ¬¡ä½¿ç”¨ï¼Œæ˜¾ç¤ºå¿«é€Ÿè®¾ç½®
          this.setData({
            pageState: 'loading',
            showQuickSetup: true
          })
          break

        case 'resume_learning':
          // æ¢å¤å­¦ä¹ 
          this.resumeLearning(state.session)
          break

        case 'show_achievement':
          // æ˜¾ç¤ºæˆå°±é¡µé¢
          this.showAchievement(state.stats)
          break

        case 'show_test_suggestion':
          // æ˜¾ç¤ºæµ‹è¯•å»ºè®®
          this.showTestSuggestionPage(state)
          break

        case 'start_learning':
          // å¼€å§‹æ–°å­¦ä¹ 
          this.startNewLearning(state)
          break

        default:
          console.error('âŒ [è¯æ±‡å­¦ä¹ ] æœªçŸ¥çŠ¶æ€:', state.action)
          this.setData({ pageState: 'loading' })
      }

    } catch (error) {
      console.error('âŒ [è¯æ±‡å­¦ä¹ ] åˆå§‹åŒ–å¤±è´¥:', error)
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      })
    }
  },

  /**
   * å¿«é€Ÿè®¾ç½®ç¡®è®¤
   */
  onSetupConfirm(e) {
    const { dailyGoal, difficultyLevel } = e.detail
    
    // ä¿å­˜è®¾ç½®
    learningDataManager.saveUserSettings({
      dailyGoal,
      difficultyLevel,
      isFirstTime: false
    })

    console.log('âœ… [è¯æ±‡å­¦ä¹ ] è®¾ç½®å·²ä¿å­˜:', { dailyGoal, difficultyLevel })

    // å…³é—­è®¾ç½®å¼¹çª—
    this.setData({
      showQuickSetup: false
    })

    // å¼€å§‹å­¦ä¹ 
    this.startNewLearning({
      state: 'new_day',
      message: 'å¼€å§‹å­¦ä¹ ï¼'
    })
  },

  /**
   * è·³è¿‡è®¾ç½®
   */
  onSetupSkip(e) {
    const { dailyGoal, difficultyLevel } = e.detail
    
    // ä¿å­˜é»˜è®¤è®¾ç½®
    learningDataManager.saveUserSettings({
      dailyGoal,
      difficultyLevel,
      isFirstTime: false
    })

    this.setData({
      showQuickSetup: false
    })

    this.startNewLearning({
      state: 'new_day',
      message: 'å¼€å§‹å­¦ä¹ ï¼'
    })
  },

  /**
   * å¼€å§‹æ–°å­¦ä¹ 
   */
  async startNewLearning(state) {
    try {
      const settings = learningDataManager.getUserSettings()
      const { dailyGoal } = settings

      // è·å–è¦å­¦ä¹ çš„å•è¯
      const words = smartLearningPlanner.getNextWords(dailyGoal)

      if (words.length === 0) {
        wx.showToast({
          title: 'æš‚æ— å¯å­¦ä¹ çš„å•è¯',
          icon: 'none'
        })
        return
      }

      // å¼€å§‹å­¦ä¹ ä¼šè¯
      learningDataManager.startNewSession(dailyGoal)

      // è®¾ç½®æ•°æ®
      this.setData({
        pageState: 'learning',
        dailyGoal,
        learnedCount: 0,
        progress: 0,
        wordsToLearn: words,
        currentIndex: 0,
        currentWord: words[0]
      })

      // å¼€å§‹AIç›‘æ§
      this.startHesitationMonitoring()

      console.log(`âœ… [è¯æ±‡å­¦ä¹ ] å¼€å§‹å­¦ä¹ ï¼Œå…±${words.length}ä¸ªå•è¯`)

    } catch (error) {
      console.error('âŒ [è¯æ±‡å­¦ä¹ ] å¼€å§‹å­¦ä¹ å¤±è´¥:', error)
      wx.showToast({
        title: 'å¼€å§‹å­¦ä¹ å¤±è´¥',
        icon: 'none'
      })
    }
  },

  /**
   * æ¢å¤å­¦ä¹ 
   */
  resumeLearning(session) {
    const { dailyGoal, learnedWords, currentIndex } = session
    const settings = learningDataManager.getUserSettings()

    // è·å–å‰©ä½™å•è¯
    const words = smartLearningPlanner.getNextWords(dailyGoal - learnedWords.length)

    this.setData({
      pageState: 'learning',
      dailyGoal,
      learnedCount: learnedWords.length,
      progress: Math.round((learnedWords.length / dailyGoal) * 100),
      wordsToLearn: words,
      currentIndex: 0,
      currentWord: words[0]
    })

    console.log(`âœ… [è¯æ±‡å­¦ä¹ ] æ¢å¤å­¦ä¹ ï¼Œå·²å­¦${learnedWords.length}ä¸ª`)
  },

  /**
   * æ ‡è®°å•è¯
   */
  markWord(e) {
    const { mastery } = e.currentTarget.dataset
    const { currentWord, currentIndex, wordsToLearn, dailyGoal } = this.data

    // åœæ­¢AIç›‘æ§
    this.stopHesitationMonitoring()

    // è®°å½•å•è¯
    learningDataManager.addLearnedWord({
      id: currentWord.id,
      word: currentWord.word,
      mastery
    })

    const newLearnedCount = this.data.learnedCount + 1
    const newProgress = Math.round((newLearnedCount / dailyGoal) * 100)

    // æ£€æŸ¥æ˜¯å¦å®Œæˆ
    if (newLearnedCount >= dailyGoal) {
      this.completeLearning()
      return
    }

    // ä¸‹ä¸€ä¸ªå•è¯
    const nextIndex = currentIndex + 1
    if (nextIndex < wordsToLearn.length) {
      this.setData({
        learnedCount: newLearnedCount,
        progress: newProgress,
        currentIndex: nextIndex,
        currentWord: wordsToLearn[nextIndex],
        errorCount: 0
      })

      // é‡æ–°å¼€å§‹AIç›‘æ§
      this.startHesitationMonitoring()
    } else {
      this.completeLearning()
    }
  },

  /**
   * å®Œæˆå­¦ä¹ 
   */
  completeLearning() {
    console.log('ğŸ‰ [è¯æ±‡å­¦ä¹ ] å®Œæˆå­¦ä¹ ')

    // åœæ­¢AIç›‘æ§
    this.stopHesitationMonitoring()

    // å®Œæˆä¼šè¯
    const completedSession = learningDataManager.completeSession()

    // è®¡ç®—ç»Ÿè®¡æ•°æ®
    const easyCount = completedSession.learnedWords.filter(w => w.mastery === 'easy').length
    const accuracy = Math.round((easyCount / completedSession.learnedWords.length) * 100)

    // æ£€æŸ¥æ˜¯å¦éœ€è¦æµ‹è¯•
    const testStatus = learningDataManager.shouldTriggerTest()

    this.setData({
      pageState: 'completed',
      sessionStats: {
        learnedCount: completedSession.learnedWords.length,
        timeSpent: completedSession.duration,
        accuracy
      },
      showTestSuggestion: testStatus.trigger,
      testSuggestionMessage: testStatus.message || 'æ ¹æ®ä½ çš„å­¦ä¹ æƒ…å†µï¼Œç°åœ¨æµ‹è¯•æ•ˆæœæœ€å¥½'
    })
  },

  /**
   * æš‚åœå­¦ä¹ 
   */
  pauseLearning() {
    learningDataManager.pauseSession()
    
    wx.showModal({
      title: 'ç¡®å®šæš‚åœå­¦ä¹ ï¼Ÿ',
      content: 'å­¦ä¹ è¿›åº¦å°†ä¼šä¿å­˜ï¼Œä¸‹æ¬¡å¯ä»¥ç»§ç»­',
      confirmText: 'ç¡®å®šæš‚åœ',
      cancelText: 'ç»§ç»­å­¦ä¹ ',
      success: (res) => {
        if (res.confirm) {
          wx.navigateBack()
        }
      }
    })
  },

  /**
   * æ˜¾ç¤ºæˆå°±é¡µé¢
   */
  showAchievement(stats) {
    const testStatus = learningDataManager.shouldTriggerTest()

    this.setData({
      pageState: 'already_completed',
      streak: stats.streak || 0,
      todayLearned: stats.todayLearned || 0,
      totalLearned: stats.totalLearned || 0,
      accuracy: Math.round(stats.accuracy || 0),
      showTestSuggestion: testStatus.trigger,
      testSuggestionMessage: testStatus.message
    })
  },

  /**
   * æ˜¾ç¤ºæµ‹è¯•å»ºè®®é¡µé¢
   */
  showTestSuggestionPage(state) {
    const record = learningDataManager.getLearningRecord()

    this.setData({
      pageState: 'already_completed',
      streak: record.streak || 0,
      todayLearned: record.todayLearned || 0,
      totalLearned: record.totalLearned || 0,
      accuracy: Math.round(record.accuracy || 0),
      showTestSuggestion: true,
      testSuggestionMessage: state.message
    })
  },

  /**
   * å¼€å§‹æµ‹è¯•
   */
  startTest() {
    console.log('ğŸ“ [è¯æ±‡å­¦ä¹ ] å¼€å§‹æµ‹è¯•')
    
    wx.navigateTo({
      url: '/pages/vocab-test/vocab-test?source=recent&count=20&duration=300'
    })
  },

  /**
   * è¿”å›é¦–é¡µ
   */
  backToHome() {
    wx.navigateBack()
  },

  // ==================== AIç›‘æ§åŠŸèƒ½ ====================

  /**
   * å¼€å§‹çŠ¹è±«ç›‘æ§
   */
  startHesitationMonitoring() {
    this.stopHesitationMonitoring()

    const timer = setTimeout(() => {
      this.showAIMessage(
        'é‡åˆ°å›°éš¾äº†å—ï¼Ÿå¦‚æœä¸ç¡®å®šï¼Œå¯ä»¥å…ˆæ ‡è®°ä¸º"ä¸è®¤è¯†"ï¼Œä¹‹åä¼šæœ‰æ›´å¤šæœºä¼šå¤ä¹ ',
        'æŸ¥çœ‹æç¤º',
        null
      )
    }, 15000) // 15ç§’

    this.setData({ hesitationTimer: timer })
  },

  /**
   * åœæ­¢çŠ¹è±«ç›‘æ§
   */
  stopHesitationMonitoring() {
    if (this.data.hesitationTimer) {
      clearTimeout(this.data.hesitationTimer)
      this.setData({ hesitationTimer: null })
    }
  },

  /**
   * æ˜¾ç¤ºAIæç¤º
   */
  showAIMessage(message, action, secondaryAction) {
    this.setData({
      showAIHint: true,
      aiHintMessage: message,
      aiHintAction: action || '',
      aiHintSecondaryAction: secondaryAction || ''
    })
  },

  /**
   * å…³é—­AIæç¤º
   */
  onDismissHint() {
    this.setData({
      showAIHint: false
    })
  },

  /**
   * æ¥å—AIæç¤º
   */
  onAcceptHint() {
    this.setData({
      showAIHint: false
    })
    // å¯ä»¥æ·»åŠ å…·ä½“çš„æç¤ºé€»è¾‘
  }
})
