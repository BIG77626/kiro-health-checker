<!--components/writing-question/writing-question.wxml-->
<view class="writing-container">
  
  <!-- ä½œæ–‡é¢˜ç›® -->
  <view class="topic-section">
    <view class="topic-header">
      <view class="topic-title-row">
        <text class="topic-number">ç¬¬{{currentQuestionIndex + 1}}é¢˜</text>
        <text class="topic-title-text">{{writingData.title}}</text>
      </view>
      <view class="analysis-btn-small" bindtap="showAnalysis">
        <text class="analysis-text">è§£æ</text>
      </view>
    </view>
    <view class="topic-content">
      <text class="topic-text">{{writingData.topic}}</text>
    </view>
    
    <!-- å›¾ç”»æè¿° -->
    <view wx:if="{{writingData.imageDescription}}" class="image-desc">
      <text class="desc-label">å›¾ç”»å†…å®¹ï¼š</text>
      <text class="desc-text">{{writingData.imageDescription}}</text>
    </view>
    
    <!-- å†™ä½œè¦æ±‚ -->
    <view wx:if="{{writingData.requirements}}" class="requirements">
      <text class="requirements-title">å†™ä½œè¦æ±‚ï¼š</text>
      <view class="requirements-list">
        <text wx:for="{{writingData.requirements}}" wx:key="index" class="requirement-item">
          {{index + 1}}. {{item}}
        </text>
      </view>
    </view>
  </view>

  <!-- ç¼–è¾‘åŒº -->
  <view wx:if="{{!isSubmitted}}" class="editor-section">
    <view class="editor-header">
      <text class="editor-title">ä½ çš„ä½œæ–‡</text>
      <view class="editor-stats">
        <text class="stat-item stat-words">å­—æ•°ï¼š{{charCount}}</text>
        <text wx:if="{{lastSaveTime}}" class="save-time">{{lastSaveTime}} å·²ä¿å­˜</text>
      </view>
    </view>
    
    <textarea
      class="essay-editor"
      placeholder="è¯·åœ¨æ­¤è¾“å…¥ä½œæ–‡å†…å®¹...\n\næç¤ºï¼šç³»ç»Ÿä¼šè‡ªåŠ¨ä¿å­˜è‰ç¨¿"
      value="{{essayContent}}"
      bindinput="onInput"
      maxlength="-1"
      auto-height
      disabled="{{isGrading}}"
    />

    <!-- å†™ä½œè¾…åŠ©å·¥å…· -->
    <view class="writing-tools">
      <button class="tool-btn" bindtap="openSentenceDrawer">
        <text class="tool-text">ä¸‡é‡‘æ²¹å¥åº“</text>
      </button>
      <button class="tool-btn" bindtap="toggleAIRecommendation">
        <text class="tool-text">{{aiRecommendEnabled ? 'AIæ¨èå·²å¼€' : 'AIæ¨èå·²å…³'}}</text>
      </button>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="editor-actions">
      <button 
        class="btn-submit-full {{essayContent.length > 0 ? '' : 'disabled'}}"
        bindtap="submitEssay"
        disabled="{{isGrading || !essayContent}}"
      >
        <text>{{isGrading ? 'AIæ‰¹æ”¹ä¸­...' : 'æäº¤æ‰¹æ”¹'}}</text>
      </button>
    </view>
  </view>

  <!-- AIæ¨èé¢æ¿ -->
  <view wx:if="{{!isSubmitted && aiRecommendEnabled && recommendedSentences.length > 0}}" class="ai-recommend-panel">
    <view class="panel-header">
      <text class="panel-title">AIæ¨èä¸‹ä¸€å¥</text>
      <view class="close-recommend" bindtap="toggleAIRecommendation">
        <text>âœ•</text>
      </view>
    </view>
    <scroll-view class="recommend-list" scroll-y>
      <view 
        wx:for="{{recommendedSentences}}" 
        wx:key="id"
        class="recommend-item"
        bindtap="insertRecommended"
        data-sentence="{{item}}"
      >
        <text class="recommend-english">{{item.english}}</text>
        <text class="recommend-chinese">{{item.chinese}}</text>
        <view class="recommend-action">
          <text class="action-text">ç‚¹å‡»æ’å…¥</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- AIæ‰¹æ”¹ç»“æœ -->
  <view wx:if="{{isSubmitted && gradingResult}}" class="result-section">
    
    <!-- æ€»åˆ†å¡ç‰‡ -->
    <view class="score-card">
      <view class="total-score">
        <text class="score-value">{{gradingResult.totalScore}}</text>
        <text class="score-label">/ 30åˆ†</text>
      </view>
    </view>

    <!-- ç»´åº¦è¯„åˆ†æ¡ -->
    <view class="score-bars">
      <view class="section-header">
        <text class="section-title">è¯„åˆ†è¯¦æƒ…</text>
      </view>
      <view class="score-bar-item">
        <view class="bar-header">
          <text class="bar-label">å†…å®¹</text>
          <text class="bar-value">{{gradingResult.contentScore}}/10</text>
        </view>
        <view class="bar-container">
          <view 
            class="bar-fill bar-content" 
            style="width: {{gradingResult.contentScore * 10}}%"
          />
        </view>
      </view>
      
      <view class="score-bar-item">
        <view class="bar-header">
          <text class="bar-label">è¯­è¨€</text>
          <text class="bar-value">{{gradingResult.languageScore}}/10</text>
        </view>
        <view class="bar-container">
          <view 
            class="bar-fill bar-language" 
            style="width: {{gradingResult.languageScore * 10}}%"
          />
        </view>
      </view>
      
      <view class="score-bar-item">
        <view class="bar-header">
          <text class="bar-label">ç»“æ„</text>
          <text class="bar-value">{{gradingResult.structureScore}}/10</text>
        </view>
        <view class="bar-container">
          <view 
            class="bar-fill bar-structure" 
            style="width: {{gradingResult.structureScore * 10}}%"
          />
        </view>
      </view>
    </view>

    <!-- AIè¯„è¯­ -->
    <view class="comments-section">
      <view class="section-header">
        <text class="section-title">AIè¯„è¯­</text>
      </view>
      <view class="comments-content">
        <text class="comments-text">{{gradingResult.comments}}</text>
      </view>
    </view>

    <!-- ä¼˜ç‚¹ -->
    <view wx:if="{{gradingResult.strengths && gradingResult.strengths.length > 0}}" class="strengths-section">
      <view class="section-header">
        <text class="section-title">âœ¨ äº®ç‚¹</text>
      </view>
      <view class="list-content">
        <view wx:for="{{gradingResult.strengths}}" wx:key="index" class="list-item strength">
          <text class="list-bullet">â€¢</text>
          <text class="list-text">{{item}}</text>
        </view>
      </view>
    </view>

    <!-- æ”¹è¿›å»ºè®® -->
    <view wx:if="{{gradingResult.suggestions && gradingResult.suggestions.length > 0}}" class="suggestions-section">
      <view class="section-header">
        <text class="section-title">ğŸ’¡ æ”¹è¿›å»ºè®®</text>
      </view>
      <view class="list-content">
        <view wx:for="{{gradingResult.suggestions}}" wx:key="index" class="list-item suggestion">
          <text class="list-bullet">{{index + 1}}.</text>
          <text class="list-text">{{item}}</text>
        </view>
      </view>
    </view>

    <!-- æ”¹è¿›ç¤ºä¾‹ -->
    <view wx:if="{{gradingResult.improvedVersion}}" class="improved-section">
      <view class="section-header">
        <text class="section-title">âœï¸ æ”¹è¿›ç¤ºä¾‹</text>
      </view>
      <view class="improved-content">
        <text class="improved-text">{{gradingResult.improvedVersion}}</text>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="result-actions">
      <button class="btn-action-single" bindtap="reEdit">
        <text>é‡æ–°ç¼–è¾‘</text>
      </button>
    </view>
  </view>

  <!-- è§£ææµ®çª— -->
  <view wx:if="{{showAnalysisModal}}" class="analysis-modal">
    <view class="modal-mask" bindtap="hideAnalysis"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">é¢˜ç›®è§£æ</text>
        <view class="modal-close" bindtap="hideAnalysis">
          <text>âœ•</text>
        </view>
      </view>
      <scroll-view class="modal-body" scroll-y>
        <view class="analysis-section">
          <text class="analysis-title">å‚è€ƒèŒƒæ–‡</text>
          <text class="analysis-text">{{writingData.sampleEssay}}</text>
        </view>
        
        <view wx:if="{{writingData.rubric}}" class="analysis-section">
          <text class="analysis-title">è¯„åˆ†æ ‡å‡†</text>
          <view class="rubric-list">
            <view class="rubric-item">
              <text class="rubric-label">å†…å®¹ï¼ˆ{{writingData.rubric.content.maxScore}}åˆ†ï¼‰ï¼š</text>
              <text class="rubric-criteria">{{writingData.rubric.content.criteria.join('ã€')}}</text>
            </view>
            <view class="rubric-item">
              <text class="rubric-label">è¯­è¨€ï¼ˆ{{writingData.rubric.language.maxScore}}åˆ†ï¼‰ï¼š</text>
              <text class="rubric-criteria">{{writingData.rubric.language.criteria.join('ã€')}}</text>
            </view>
            <view class="rubric-item">
              <text class="rubric-label">ç»“æ„ï¼ˆ{{writingData.rubric.structure.maxScore}}åˆ†ï¼‰ï¼š</text>
              <text class="rubric-criteria">{{writingData.rubric.structure.criteria.join('ã€')}}</text>
            </view>
          </view>
        </view>
        
        <view class="analysis-section">
          <text class="analysis-title">å†™ä½œæŠ€å·§</text>
          <view class="tips-list">
            <text class="tip-item">â€¢ å¼€å¤´æ®µï¼šæè¿°å›¾ç”»å†…å®¹ï¼Œå¼•å‡ºè¯é¢˜</text>
            <text class="tip-item">â€¢ ä¸»ä½“æ®µï¼šåˆ†æåŸå› ã€å½±å“æˆ–æ„ä¹‰</text>
            <text class="tip-item">â€¢ ç»“å°¾æ®µï¼šæ€»ç»“è§‚ç‚¹ï¼Œæå‡ºå»ºè®®æˆ–å±•æœ›</text>
            <text class="tip-item">â€¢ ä½¿ç”¨è¿‡æ¸¡è¯è¿æ¥æ®µè½ï¼Œä¿æŒé€»è¾‘è¿è´¯</text>
            <text class="tip-item">â€¢ é€‚å½“ä½¿ç”¨é«˜çº§è¯æ±‡å’Œå¤æ‚å¥å¼</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- ä¸‡é‡‘æ²¹å¥åº“æŠ½å±‰ -->
  <view class="sentence-drawer-container" wx:if="{{showSentenceDrawer}}">
    <!-- é®ç½©å±‚ -->
    <view class="drawer-mask" bindtap="closeSentenceDrawer"></view>
    
    <!-- æŠ½å±‰ä¸»ä½“ -->
    <view class="drawer-content">
      <!-- é¡¶éƒ¨æŠŠæ‰‹ -->
      <view class="drawer-handle">
        <view class="handle-bar"></view>
      </view>
      
      <!-- å¤´éƒ¨ -->
      <view class="drawer-header">
        <view class="header-left">
          <text class="header-title">ä¸‡é‡‘æ²¹å¥åº“</text>
          <text class="header-count">({{filteredSentences.length}})</text>
        </view>
        <view class="header-right">
          <view class="icon-btn" bindtap="toggleFavoriteFilter">
            <text class="icon">{{showFavoriteOnly ? 'â­' : 'â˜†'}}</text>
            <text class="btn-text">æ”¶è—</text>
          </view>
          <view class="icon-btn" bindtap="closeSentenceDrawer">
            <text class="icon">âœ•</text>
          </view>
        </view>
      </view>
      
      <!-- æœç´¢æ  -->
      <view class="search-section">
        <view class="search-box">
          <text class="search-icon">ğŸ”</text>
          <input 
            class="search-input"
            placeholder="æœç´¢å¥å­ã€åŠŸèƒ½ã€æ ‡ç­¾..."
            value="{{searchKeyword}}"
            bindinput="onSearchSentence"
          />
          <text 
            wx:if="{{searchKeyword}}" 
            class="clear-icon"
            bindtap="clearSearch"
          >âœ•</text>
        </view>
      </view>
      
      <!-- ç­›é€‰Tab -->
      <view class="filter-section">
        <!-- å±‚çº§ç­›é€‰ -->
        <view class="tier-tabs">
          <view 
            wx:for="{{tiers}}" 
            wx:key="id"
            class="tier-tab {{activeTier === item.id ? 'active' : ''}}"
            bindtap="onTierChange"
            data-tier="{{item.id}}"
          >
            <text class="tier-name">{{item.name}}</text>
          </view>
        </view>
        
        <!-- åˆ†ç±»Tab -->
        <scroll-view class="category-tabs" scroll-x>
          <view class="tab-group">
            <text class="tab-label">ä½ç½®:</text>
            <view 
              wx:for="{{positions}}" 
              wx:key="id"
              class="category-tab {{activePosition === item.id ? 'active' : ''}}"
              bindtap="onPositionChange"
              data-position="{{item.id}}"
            >
              <text class="tab-icon">{{item.icon}}</text>
              <text class="tab-text">{{item.name}}</text>
            </view>
          </view>
        </scroll-view>
      </view>
      
      <!-- å¥å­åˆ—è¡¨ -->
      <scroll-view class="sentence-list" scroll-y>
        <view wx:if="{{filteredSentences.length === 0}}" class="empty-state">
          <text class="empty-icon">ğŸ”</text>
          <text class="empty-text">æœªæ‰¾åˆ°ç›¸å…³å¥å­</text>
          <text class="empty-hint">è¯•è¯•å…¶ä»–å…³é”®è¯æˆ–ç­›é€‰æ¡ä»¶</text>
        </view>
        
        <view wx:else>
          <view 
            wx:for="{{filteredSentences}}" 
            wx:key="id"
            class="sentence-card-mini"
          >
            <!-- å¤´éƒ¨ -->
            <view class="card-header-mini">
              <view class="tags-mini">
                <text class="tier-tag tier-{{item.tier}}">{{tierNames[item.tier]}}</text>
                <text class="difficulty-tag" wx:if="{{item.meta.difficulty === 1}}">â˜…</text>
                <text class="difficulty-tag" wx:if="{{item.meta.difficulty === 2}}">â˜…â˜…</text>
                <text class="difficulty-tag" wx:if="{{item.meta.difficulty === 3}}">â˜…â˜…â˜…</text>
                <text class="difficulty-tag" wx:if="{{item.meta.difficulty === 4}}">â˜…â˜…â˜…â˜…</text>
                <text class="difficulty-tag" wx:if="{{item.meta.difficulty === 5}}">â˜…â˜…â˜…â˜…â˜…</text>
              </view>
              <view class="favorite-btn-mini" bindtap="toggleFavoriteSentence" data-id="{{item.id}}">
                <text class="fav-icon">{{favoriteSentenceIds.includes(item.id) ? 'â­' : 'â˜†'}}</text>
              </view>
            </view>
            
            <!-- å¥å­å†…å®¹ -->
            <view class="card-body-mini">
              <text class="english-text-mini">{{item.english}}</text>
              <text class="chinese-text-mini">{{item.chinese}}</text>
            </view>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <view class="card-actions-mini">
              <button class="action-btn-mini secondary" bindtap="showSentenceDetail" data-sentence="{{item}}">
                è¯¦æƒ…({{item.variants.length}}å˜ä½“)
              </button>
              <button class="action-btn-mini primary" bindtap="insertSentence" data-sentence="{{item}}">
                æ’å…¥
              </button>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- å¥å­è¯¦æƒ…å¼¹çª— -->
  <sentence-detail-modal
    visible="{{showDetailModal}}"
    sentence="{{selectedSentence}}"
    isFavorite="{{favoriteSentenceIds.includes(selectedSentence.id)}}"
    bind:close="closeDetailModal"
    bind:insert="insertSentence"
    bind:favorite="toggleFavoriteSentence"
  />

</view>


