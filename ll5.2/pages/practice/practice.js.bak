// pages/practice/practice.js
const { CloudDatabase } = require('../../utils/cloud.js')
const { showError, showSuccess, showLoading, hideLoading } = require('../../utils/util.js')
const { progressTracker } = require('../../utils/progress-tracker.js')
const themeUtils = require('../../utils/theme.js')
const { sampleReadingData } = require('../../data/sample-reading.js')
const { sampleClozeData } = require('../../data/sample-cloze.js')
const { sampleTranslationData } = require('../../data/sample-translation.js')
const { sampleWritingData } = require('../../data/sample-writing.js')
const AIHintGenerator = require('../../utils/short-chain-thinking/ai-hint-generator.js')
const { practiceProgressManager } = require('../../utils/practice-progress.js')
const { friendlyErrorManager } = require('../../utils/friendly-error.js')

const paperDB = new CloudDatabase('papers')
const studyRecordDB = new CloudDatabase('studyrecords')

Page({
  data: {
    paper: null,
    questions: [],
    passages: [],
    currentQuestionIndex: 0,
    userAnswers: {},
    isLoading: true,
    showResult: false,
    showExplanation: false,
    startTime: 0,
    timeSpent: 0,
    formattedTime: '0:00',
    timer: null,
    practiceMode: 'practice', // practice æˆ– exam

    // ç­”é¢˜ç»Ÿè®¡
    stats: {
      total: 0,
      answered: 0,
      correct: 0,
      accuracy: 0
    },

    // ä¸»é¢˜è®¾ç½®
    showThemeSetup: false,
    systemTheme: 'light',

    // AI æç¤ºç›¸å…³
    showHint: false,
    hintMessage: '',
    hintPoints: [],
    hintKeywords: [],
    hintAutoExpand: false,
    idleTime: 0,        // ç©ºé—²æ—¶é—´ï¼ˆç§’ï¼‰
    attempts: 0          // ä½œç­”å°è¯•æ¬¡æ•°
  },

  onLoad(options) {
    console.log('ã€ç»ƒä¹ é¡µé¢å‚æ•°ã€‘', options) // è°ƒè¯•ä¿¡æ¯

    const { paperId, mode = 'practice', type, typeName, continue: shouldContinue, questionIndex } = options

    // è®¾ç½®å¯¼èˆªæ æ ‡é¢˜
    if (typeName) {
      wx.setNavigationBarTitle({
        title: typeName
      })
    }

    this.setData({
      paperId: paperId || `sample-${type}-001`,
      practiceMode: mode,
      practiceType: type || 'reading',
      startTime: Date.now()
    })

    // å¦‚æœæ˜¯ç»§ç»­ç»ƒä¹ ï¼Œæ¢å¤è¿›åº¦
    if (shouldContinue === 'true') {
      const lastProgress = practiceProgressManager.getLastProgress()
      if (lastProgress && lastProgress.userAnswers) {
        this.setData({
          userAnswers: lastProgress.userAnswers,
          currentQuestionIndex: parseInt(questionIndex) || 0,
          startTime: lastProgress.startTime || Date.now()
        })
        console.log('âœ… å·²æ¢å¤ç»ƒä¹ è¿›åº¦:', lastProgress)
      }
    }

    // åˆå§‹åŒ– AI æç¤ºç”Ÿæˆå™¨
    this.aiHintGenerator = new AIHintGenerator()

    // å¯åŠ¨ç©ºé—²æ—¶é—´ç›‘æ§ï¼ˆæ¯ç§’æ›´æ–°ï¼‰
    this.idleTimer = setInterval(() => {
      const idleTime = this.data.idleTime + 1
      this.setData({ idleTime })

      // å¦‚æœç©ºé—²è¶…è¿‡ 30 ç§’ä¸”æœªæ˜¾ç¤ºæç¤ºï¼Œè‡ªåŠ¨è§¦å‘
      if (idleTime === 30 && !this.data.showHint && this.data.practiceMode === 'practice') {
        this.triggerAIHint()
      }
    }, 1000)

    // å¦‚æœæ²¡æœ‰ paperIdï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®
    if (!paperId && type) {
      this.loadSampleData(type)
      return
    }

    if (!paperId) {
      console.error('âŒ ç»ƒä¹ é¡µé¢å‚æ•°ç¼ºå¤±: paperId æˆ– type')
      friendlyErrorManager.showBusinessError('parameter error', {
        title: 'å‚æ•°é”™è¯¯',
        message: 'ç¼ºå°‘å¿…è¦å‚æ•°ï¼Œæ— æ³•å¼€å§‹ç»ƒä¹ ',
        showModal: true
      })
      setTimeout(() => {
        wx.navigateBack()
      }, 2000)
      return
    }

    this.setData({
      paperId: paperId,
      practiceMode: mode,
      startTime: Date.now()
    })

    // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„ä¼šè¯
    const hasUnfinishedSession = progressTracker.restoreSession()
    if (hasUnfinishedSession) {
      const sessionStatus = progressTracker.getSessionStatus()
      if (sessionStatus.isActive && sessionStatus.sessionData.currentPaper.id === paperId) {
        wx.showModal({
          title: 'ç»§ç»­å­¦ä¹ ',
          content: 'æ£€æµ‹åˆ°æœªå®Œæˆçš„ç»ƒä¹ ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ',
          confirmText: 'ç»§ç»­',
          cancelText: 'é‡æ–°å¼€å§‹',
          success: (res) => {
            if (res.confirm) {
              // ç»§ç»­ä¹‹å‰çš„ä¼šè¯
              this.setData({
                userAnswers: sessionStatus.sessionData.answers || {},
                startTime: sessionStatus.sessionData.startTime
              })
            } else {
              // å¼€å§‹æ–°ä¼šè¯
              progressTracker.clearSession()
              this.startNewSession(paperId)
            }
            this.loadPracticeData(paperId)
            this.startTimer()
          }
        })
        return
      }
    }

    // å¼€å§‹æ–°çš„å­¦ä¹ ä¼šè¯
    this.startNewSession(paperId)
    this.loadPracticeData(paperId)
    this.startTimer()

    // æ£€æŸ¥ä¸»é¢˜è®¾ç½®
    this.checkThemeSetup()
  },

  onUnload() {
    // é¡µé¢å¸è½½æ—¶æ¸…é™¤è®¡æ—¶å™¨
    if (this.data.timer) {
      clearInterval(this.data.timer)
    }
  },

  /**
   * å¤„ç†ç­”é¢˜äº‹ä»¶
   */
  onAnswer(e) {
    const detail = e.detail
    console.log('ğŸ“ ç­”é¢˜:', detail)

    // æ›´æ–°ç­”é¢˜è®°å½•
    const answers = this.data.userAnswers || {}
    answers[detail.questionId || detail.blankId] = {
      answer: detail.answer,
      isCorrect: detail.isCorrect,
      timestamp: Date.now()
    }

    this.setData({
      userAnswers: answers
    })
  },

  /**
   * åˆ‡æ¢åˆ°ä¸‹ä¸€ç¯‡æ–‡ç« ï¼ˆé˜…è¯»ç†è§£ï¼‰
   */
  nextPassage() {
    const nextIndex = this.data.currentPassageIndex + 1
    if (nextIndex < this.data.passages.length) {
      this.setData({
        currentPassageIndex: nextIndex,
        currentPassage: this.data.passages[nextIndex],
        questions: this.data.passages[nextIndex].questions
      })

      wx.showToast({
        title: `ç¬¬ ${nextIndex + 1} ç¯‡`,
        icon: 'success',
        duration: 1000
      })
    } else {
      // æ‰€æœ‰æ–‡ç« å®Œæˆ
      wx.showModal({
        title: 'ç»ƒä¹ å®Œæˆ',
        content: 'æ˜¯å¦æäº¤æŸ¥çœ‹ç»“æœï¼Ÿ',
        success: (res) => {
          if (res.confirm) {
            this.submitPractice()
          }
        }
      })
    }
  },

  /**
   * åˆ‡æ¢åˆ°ä¸‹ä¸€é“å†™ä½œé¢˜
   */
  nextWritingQuestion() {
    const nextIndex = this.data.currentQuestionIndex + 1
    if (nextIndex < this.data.questions.length) {
      this.setData({
        currentQuestionIndex: nextIndex
      })

      wx.showToast({
        title: `ç¬¬ ${nextIndex + 1} é¢˜`,
        icon: 'success',
        duration: 1000
      })
    } else {
      // æ‰€æœ‰é¢˜ç›®å®Œæˆ
      wx.showModal({
        title: 'å†™ä½œç»ƒä¹ å®Œæˆ',
        content: 'å·²å®Œæˆæ‰€æœ‰é¢˜ç›®',
        success: (res) => {
          if (res.confirm) {
            wx.navigateTo({ url: '/pages/report/report' })
          }
        }
      })
    }
  },

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  goBack() {
    wx.navigateBack()
  },

  // å¼€å§‹æ–°çš„å­¦ä¹ ä¼šè¯
  startNewSession(paperId) {
    const paperTitle = this.data.paper?.title || `ç»ƒä¹ ${paperId}`
    progressTracker.startSession(paperId, paperTitle, this.data.practiceMode)
    console.log('ğŸš€ å¼€å§‹æ–°çš„å­¦ä¹ ä¼šè¯:', paperId)
  },

  /**
   * åŠ è½½ç¤ºä¾‹æ•°æ®
   */
  loadSampleData(type) {
    console.log('ğŸ“ åŠ è½½ç¤ºä¾‹æ•°æ®:', type)

    this.setData({ isLoading: true })

    try {
      let data = null

      switch(type) {
        case 'reading':
          data = {
            passages: sampleReadingData,
            currentPassageIndex: 0,
            currentPassage: sampleReadingData[0],
            questions: sampleReadingData[0].questions
          }
          break

        case 'cloze':
          data = {
            clozeData: sampleClozeData[0],
            questions: sampleClozeData[0].blanks
          }
          break

        case 'translation':
          data = {
            translationData: sampleTranslationData[0],
            questions: [sampleTranslationData[0]] // ç”¨äºç»Ÿè®¡
          }
          break

        case 'writing':
          data = {
            writingData: sampleWritingData,
            questions: sampleWritingData.questions,
            currentQuestionIndex: 0
          }
          break

        default:
          friendlyErrorManager.showBusinessError('no_questions', {
            message: 'æš‚ä¸æ”¯æŒè¯¥é¢˜å‹'
          })
          setTimeout(() => wx.navigateBack(), 1500)
          return
      }

      this.setData({
        ...data,
        isLoading: false
      })

      console.log('âœ… ç¤ºä¾‹æ•°æ®åŠ è½½å®Œæˆ')
      console.log('ğŸ“Š å½“å‰æ•°æ®çŠ¶æ€:', {
        practiceType: this.data.practiceType,
        hasQuestions: !!this.data.questions,
        questionsLength: this.data.questions?.length,
        currentQuestionIndex: this.data.currentQuestionIndex,
        hasWritingData: !!this.data.writingData
      })

    } catch (error) {
      console.error('âŒ åŠ è½½ç¤ºä¾‹æ•°æ®å¤±è´¥:', error)
      friendlyErrorManager.show(error, {
        title: 'åŠ è½½å¤±è´¥',
        message: 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•'
      })
      this.setData({ isLoading: false })
    }
  },

  async loadPracticeData(paperId) {
    this.setData({ isLoading: true })
    showLoading('åŠ è½½é¢˜ç›®ä¸­...')

    // è®¾ç½®5ç§’åŠ è½½è¶…æ—¶
    const loadingTimeout = setTimeout(() => {
      if (this.data.isLoading) {
        console.warn('âš ï¸ åŠ è½½è¶…æ—¶ï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®')
        this.loadSampleData(paperId)
        hideLoading()
        this.setData({ isLoading: false })
      }
    }, 5000)

    try {
      // åŠ è½½è¯•å·æ•°æ®
      let paper = null

      // å¦‚æœpaperIdæ˜¯'recommended'ï¼Œå°è¯•åŠ è½½æ¨èçš„è¯•å·
      if (paperId === 'recommended') {
        console.log('ğŸ” åŠ è½½æ¨èè¯•å·æ•°æ®')
        // å°è¯•ä»papersé›†åˆä¸­è·å–ç¬¬ä¸€ä¸ªå¯ç”¨çš„è¯•å·
        const papers = await paperDB.list('-year', 1)
        if (papers && papers.length > 0) {
          paper = papers[0]
          console.log('ğŸ” ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨è¯•å·ä½œä¸ºæ¨èè¯•å·:', paper)
        } else {
          console.warn('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¯ç”¨è¯•å·ï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®')
          console.warn('ğŸ’¡ å¯èƒ½åŸå› ï¼šæ•°æ®åº“ä¸­æœªæ‰¾åˆ°è¯•å·ï¼Œæˆ–è¯•å·æ•°æ®æ ¼å¼ä¸å®Œæ•´')
          console.warn('ğŸ”§ è§£å†³æ–¹æ¡ˆï¼šè¿è¡Œæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬æ·»åŠ ç¤ºä¾‹æ•°æ®')
          this.loadSampleData(paperId)
          return
        }
      } else if (paperId.includes('sample_')) {
        // å¦‚æœæ˜¯ç¤ºä¾‹æ•°æ®IDï¼Œç›´æ¥åŠ è½½ç¤ºä¾‹æ•°æ®
        console.log('ğŸ” æ£€æµ‹åˆ°ç¤ºä¾‹æ•°æ®IDï¼Œç›´æ¥åŠ è½½ç¤ºä¾‹æ•°æ®:', paperId)
        this.loadSampleData(paperId)
        return
      } else {
        // æ­£å¸¸åŠ è½½æŒ‡å®šIDçš„è¯•å·
        paper = await paperDB.get(paperId)
      }

      console.log('ğŸ” ç»ƒä¹ é¡µé¢åŠ è½½çš„è¯•å·æ•°æ®:', paper) // è°ƒè¯•ä¿¡æ¯

      if (!paper || !paper.content || !paper.content.questions) {
        console.warn('âš ï¸ è¯•å·æ•°æ®ä¸å®Œæ•´ï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®')
        console.warn('ğŸ’¡ å¯èƒ½åŸå› ï¼šæ•°æ®åº“ä¸­æœªæ‰¾åˆ°è¯•å·ï¼Œæˆ–è¯•å·æ•°æ®æ ¼å¼ä¸å®Œæ•´')
        console.warn('ğŸ”§ è§£å†³æ–¹æ¡ˆï¼šè¿è¡Œæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬æ·»åŠ ç¤ºä¾‹æ•°æ®')
        this.loadSampleData(paperId)
        return
      }

      const questions = paper.content.questions || []
      const passages = paper.content.passages || []

      console.log('ğŸ” åŠ è½½çš„é¢˜ç›®æ•°é‡:', questions.length) // è°ƒè¯•ä¿¡æ¯
      console.log('ğŸ” åŠ è½½çš„æ–‡ç« æ•°é‡:', passages.length) // è°ƒè¯•ä¿¡æ¯

      if (questions.length === 0) {
        friendlyErrorManager.showBusinessError('no_questions', {
          showModal: true
        })
        setTimeout(() => {
          wx.navigateBack()
        }, 2000)
        return
      }

      this.setData({
        paper: paper,
        questions: questions,
        passages: passages,
        isLoading: false,
        'stats.total': questions.length
      })

      // è®¾ç½®é¡µé¢æ ‡é¢˜
      wx.setNavigationBarTitle({
        title: `ç»ƒä¹  - ${paper.title || 'è€ƒç ”è‹±è¯­'}`
      })

    } catch (error) {
      console.error('âŒ åŠ è½½ç»ƒä¹ æ•°æ®å¤±è´¥:', error)
      console.log('ğŸ”„ ä½¿ç”¨ç¤ºä¾‹æ•°æ®')

      // æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
      if (error.errCode === -502003) {
        console.warn('âš ï¸ æ•°æ®åº“æƒé™é”™è¯¯æˆ–ç¯å¢ƒæœªé…ç½®')
      } else if (error.errCode === -502001) {
        console.warn('âš ï¸ æ–‡æ¡£ä¸å­˜åœ¨ï¼ŒpaperId:', paperId)
      }

      // å¦‚æœæ˜¯æ–‡æ¡£ä¸å­˜åœ¨çš„é”™è¯¯ï¼Œç›´æ¥åŠ è½½ç¤ºä¾‹æ•°æ®
      if (error.errMsg && error.errMsg.includes('cannot find document')) {
        console.log('ğŸ” æ–‡æ¡£ä¸å­˜åœ¨ï¼ŒåŠ è½½ç¤ºä¾‹æ•°æ®:', paperId)
        this.loadSampleData(paperId)
      } else {
        // å…¶ä»–é”™è¯¯ä¹ŸåŠ è½½ç¤ºä¾‹æ•°æ®ä½œä¸ºåå¤‡æ–¹æ¡ˆ
        console.log('ğŸ” åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®ä½œä¸ºåå¤‡æ–¹æ¡ˆ:', paperId)
        this.loadSampleData(paperId)
      }
    } finally {
      // ç¡®ä¿æ— è®ºå¦‚ä½•éƒ½ä¼šæ¸…é™¤è¶…æ—¶å¹¶éšè—åŠ è½½çŠ¶æ€
      clearTimeout(loadingTimeout)
      hideLoading()
    }
  },

  loadSampleData(paperId) {
    console.log('ğŸ” åŠ è½½ç¤ºä¾‹ç»ƒä¹ æ•°æ®ï¼ŒpaperId:', paperId)

    // æ ¹æ®ä¸åŒçš„é¢˜å‹åŠ è½½ä¸åŒçš„ç¤ºä¾‹æ•°æ®
    let sampleQuestions = []
    let samplePassages = []

    if (paperId.includes('reading') || paperId.includes('reading_comprehension') || paperId.includes('sample_reading_comprehension')) {
      // é˜…è¯»ç†è§£é¢˜å‹
      sampleQuestions = [
        {
          id: 'q1',
          type: 'reading_a',
          passage_id: 'passage_1',
          question: 'According to the passage, what is the main impact of technology on modern life?',
          options: [
            'A. It has made life more complicated and stressful',
            'B. It has transformed how we interact with the world',
            'C. It has reduced our productivity significantly',
            'D. It has eliminated traditional communication methods'
          ],
          correct_answer: 'B',
          evidence_paragraphs: [1],
          evidence_sentences: ['The rapid advancement of technology has fundamentally transformed how we interact with the world around us'],
          explanation: 'æ–‡ç« å¼€å¤´æ˜ç¡®æŒ‡å‡ºæŠ€æœ¯çš„å¿«é€Ÿå‘å±•ä»æ ¹æœ¬ä¸Šæ”¹å˜äº†æˆ‘ä»¬ä¸å‘¨å›´ä¸–ç•Œçš„äº’åŠ¨æ–¹å¼ã€‚',
          difficulty_tips: ['æ³¨æ„å…³é”®è¯"transformed"', 'ç†è§£"interact"çš„å«ä¹‰']
        },
        {
          id: 'q2',
          type: 'reading_a',
          passage_id: 'passage_1',
          question: 'What does the author suggest about dealing with technology?',
          options: [
            'A. We should completely avoid using technology',
            'B. We should use technology without any restrictions',
            'C. We should maintain a balanced approach to technology',
            'D. We should rely entirely on artificial intelligence'
          ],
          correct_answer: 'C',
          evidence_paragraphs: [3],
          evidence_sentences: ['maintain a balanced approach to technology adoption'],
          explanation: 'æ–‡ç« ç¬¬ä¸‰æ®µæåˆ°éœ€è¦ä¿æŒæŠ€æœ¯é‡‡ç”¨çš„å¹³è¡¡æ–¹æ³•ã€‚',
          difficulty_tips: ['å…³æ³¨"balanced approach"è¿™ä¸ªå…³é”®çŸ­è¯­']
        },
        {
          id: 'q3',
          type: 'reading_a',
          passage_id: 'passage_1',
          question: 'The phrase "digital landscape" in paragraph 3 most likely refers to:',
          options: [
            'A. Physical locations where technology is used',
            'B. The overall environment of digital technology',
            'C. Geographical maps created by computers',
            'D. Artistic representations of digital concepts'
          ],
          correct_answer: 'B',
          evidence_paragraphs: [3],
          evidence_sentences: ['As we navigate this digital landscape'],
          explanation: '"Digital landscape"åœ¨è¿™é‡Œæ˜¯æ¯”å–»ç”¨æ³•ï¼ŒæŒ‡çš„æ˜¯æ•´ä¸ªæ•°å­—æŠ€æœ¯ç¯å¢ƒã€‚',
          difficulty_tips: ['ç†è§£æ¯”å–»ç”¨æ³•', 'ç»“åˆä¸Šä¸‹æ–‡ç†è§£è¯æ±‡å«ä¹‰']
        }
      ]
      samplePassages = [
        {
          id: 'passage_1',
          title: 'Technology and Modern Society',
          paragraphs: [
            {
              number: 1,
              text: 'The rapid advancement of technology has fundamentally transformed how we interact with the world around us. From smartphones that connect us globally to artificial intelligence that assists in decision-making, technology permeates every aspect of modern life.',
              translation: 'æŠ€æœ¯çš„å¿«é€Ÿå‘å±•ä»æ ¹æœ¬ä¸Šæ”¹å˜äº†æˆ‘ä»¬ä¸å‘¨å›´ä¸–ç•Œçš„äº’åŠ¨æ–¹å¼ã€‚ä»è¿æ¥å…¨çƒçš„æ™ºèƒ½æ‰‹æœºåˆ°ååŠ©å†³ç­–çš„äººå·¥æ™ºèƒ½ï¼ŒæŠ€æœ¯æ¸—é€åˆ°ç°ä»£ç”Ÿæ´»çš„å„ä¸ªæ–¹é¢ã€‚'
            },
            {
              number: 2,
              text: 'However, this technological revolution brings both opportunities and challenges. While digital tools enhance productivity and create new possibilities for communication and learning, they also raise concerns about privacy, employment displacement, and social isolation.',
              translation: 'ç„¶è€Œï¼Œè¿™åœºæŠ€æœ¯é©å‘½æ—¢å¸¦æ¥äº†æœºé‡ä¹Ÿå¸¦æ¥äº†æŒ‘æˆ˜ã€‚è™½ç„¶æ•°å­—å·¥å…·æé«˜äº†ç”Ÿäº§åŠ›ï¼Œä¸ºæ²Ÿé€šå’Œå­¦ä¹ åˆ›é€ äº†æ–°çš„å¯èƒ½æ€§ï¼Œä½†å®ƒä»¬ä¹Ÿå¼•å‘äº†å¯¹éšç§ã€å°±ä¸šæ›¿ä»£å’Œç¤¾ä¼šå­¤ç«‹çš„æ‹…å¿§ã€‚'
            },
            {
              number: 3,
              text: 'As we navigate this digital landscape, it becomes crucial to develop digital literacy and maintain a balanced approach to technology adoption. The key lies not in avoiding technology, but in understanding how to harness its benefits while mitigating its potential drawbacks.',
              translation: 'å½“æˆ‘ä»¬åœ¨è¿™ä¸ªæ•°å­—åŒ–ç¯å¢ƒä¸­ç©¿è¡Œæ—¶ï¼ŒåŸ¹å…»æ•°å­—ç´ å…»å¹¶ä¿æŒæŠ€æœ¯é‡‡ç”¨çš„å¹³è¡¡æ–¹æ³•å˜å¾—è‡³å…³é‡è¦ã€‚å…³é”®ä¸åœ¨äºé¿å…æŠ€æœ¯ï¼Œè€Œåœ¨äºäº†è§£å¦‚ä½•åˆ©ç”¨å…¶ä¼˜åŠ¿åŒæ—¶å‡è½»å…¶æ½œåœ¨ç¼ºç‚¹ã€‚'
            }
          ]
        }
      ]
    } else if (paperId.includes('cloze') || paperId.includes('sample_cloze_test')) {
      // å®Œå½¢å¡«ç©ºé¢˜å‹
      sampleQuestions = [
        {
          id: 'cloze_1',
          type: 'cloze',
          question: 'The internet has _____ the way we communicate with each other.',
          options: [
            'A. revolutionized',
            'B. complicated',
            'C. simplified',
            'D. eliminated'
          ],
          correct_answer: 'A',
          explanation: 'äº’è”ç½‘"é©å‘½æ€§åœ°æ”¹å˜"äº†æˆ‘ä»¬å½¼æ­¤æ²Ÿé€šçš„æ–¹å¼ï¼Œrevolutionizedæœ€ç¬¦åˆè¯­å¢ƒã€‚',
          difficulty_tips: ['ç†è§£åŠ¨è¯å«ä¹‰', 'æ³¨æ„è¯­å¢ƒæš—ç¤º']
        },
        {
          id: 'cloze_2',
          type: 'cloze',
          question: 'Social media platforms allow users to _____ their thoughts and experiences instantly.',
          options: [
            'A. hide',
            'B. share',
            'C. delete',
            'D. forget'
          ],
          correct_answer: 'B',
          explanation: 'ç¤¾äº¤åª’ä½“å¹³å°è®©ç”¨æˆ·èƒ½å¤Ÿå³æ—¶"åˆ†äº«"ä»–ä»¬çš„æƒ³æ³•å’Œç»å†ã€‚',
          difficulty_tips: ['ç†è§£ç¤¾äº¤åª’ä½“çš„ä½œç”¨', 'æ³¨æ„å‰¯è¯instantlyçš„æç¤º']
        }
      ]
    } else if (paperId.includes('new_type') || paperId.includes('sample_new_question_type')) {
      // æ–°é¢˜å‹
      sampleQuestions = [
        {
          id: 'new_1',
          type: 'seven_choose_five',
          question: 'æ ¹æ®ä¸Šä¸‹æ–‡ï¼Œé€‰æ‹©æœ€åˆé€‚çš„å¥å­å¡«å…¥ç©ºç™½å¤„ï¼š',
          options: [
            'A. This trend is expected to continue in the coming years.',
            'B. However, not everyone agrees with this perspective.',
            'C. The research was conducted over a period of five years.',
            'D. These findings have important implications for policy makers.',
            'E. Technology companies are investing heavily in this area.',
            'F. Critics argue that more research is needed.',
            'G. The results were published in a leading scientific journal.'
          ],
          correct_answer: 'A',
          explanation: 'æ ¹æ®å‰åæ–‡çš„é€»è¾‘å…³ç³»ï¼Œè¿™é‡Œéœ€è¦ä¸€ä¸ªæ€»ç»“æ€§çš„å¥å­ï¼ŒAé€‰é¡¹æœ€ç¬¦åˆè¯­å¢ƒã€‚',
          difficulty_tips: ['æ³¨æ„é€»è¾‘è¿æ¥è¯', 'ç†è§£æ®µè½ç»“æ„']
        }
      ]
    } else {
      // é»˜è®¤é˜…è¯»ç†è§£
      sampleQuestions = [
        {
          id: 'q1',
          type: 'reading_a',
          passage_id: 'passage_1',
          question: 'According to the passage, what is the main impact of technology on modern life?',
          options: [
            'A. It has made life more complicated and stressful',
            'B. It has transformed how we interact with the world',
            'C. It has reduced our productivity significantly',
            'D. It has eliminated traditional communication methods'
          ],
          correct_answer: 'B',
          evidence_paragraphs: [1],
          evidence_sentences: ['The rapid advancement of technology has fundamentally transformed how we interact with the world around us'],
          explanation: 'æ–‡ç« å¼€å¤´æ˜ç¡®æŒ‡å‡ºæŠ€æœ¯çš„å¿«é€Ÿå‘å±•ä»æ ¹æœ¬ä¸Šæ”¹å˜äº†æˆ‘ä»¬ä¸å‘¨å›´ä¸–ç•Œçš„äº’åŠ¨æ–¹å¼ã€‚',
          difficulty_tips: ['æ³¨æ„å…³é”®è¯"transformed"', 'ç†è§£"interact"çš„å«ä¹‰']
        }
      ]
    }

    // å¦‚æœæ²¡æœ‰è®¾ç½®passagesï¼Œä½¿ç”¨é»˜è®¤çš„
    if (samplePassages.length === 0) {
      samplePassages = [
        {
          id: 'passage_1',
          title: 'Technology and Modern Society',
          paragraphs: [
            {
              number: 1,
              text: 'The rapid advancement of technology has fundamentally transformed how we interact with the world around us. From smartphones that connect us globally to artificial intelligence that assists in decision-making, technology permeates every aspect of modern life.',
              translation: 'æŠ€æœ¯çš„å¿«é€Ÿå‘å±•ä»æ ¹æœ¬ä¸Šæ”¹å˜äº†æˆ‘ä»¬ä¸å‘¨å›´ä¸–ç•Œçš„äº’åŠ¨æ–¹å¼ã€‚ä»è¿æ¥å…¨çƒçš„æ™ºèƒ½æ‰‹æœºåˆ°ååŠ©å†³ç­–çš„äººå·¥æ™ºèƒ½ï¼ŒæŠ€æœ¯æ¸—é€åˆ°ç°ä»£ç”Ÿæ´»çš„å„ä¸ªæ–¹é¢ã€‚'
            },
            {
              number: 2,
              text: 'However, this technological revolution brings both opportunities and challenges. While digital tools enhance productivity and create new possibilities for communication and learning, they also raise concerns about privacy, employment displacement, and social isolation.',
              translation: 'ç„¶è€Œï¼Œè¿™åœºæŠ€æœ¯é©å‘½æ—¢å¸¦æ¥äº†æœºé‡ä¹Ÿå¸¦æ¥äº†æŒ‘æˆ˜ã€‚è™½ç„¶æ•°å­—å·¥å…·æé«˜äº†ç”Ÿäº§åŠ›ï¼Œä¸ºæ²Ÿé€šå’Œå­¦ä¹ åˆ›é€ äº†æ–°çš„å¯èƒ½æ€§ï¼Œä½†å®ƒä»¬ä¹Ÿå¼•å‘äº†å¯¹éšç§ã€å°±ä¸šæ›¿ä»£å’Œç¤¾ä¼šå­¤ç«‹çš„æ‹…å¿§ã€‚'
            },
            {
              number: 3,
              text: 'As we navigate this digital landscape, it becomes crucial to develop digital literacy and maintain a balanced approach to technology adoption. The key lies not in avoiding technology, but in understanding how to harness its benefits while mitigating its potential drawbacks.',
              translation: 'å½“æˆ‘ä»¬åœ¨è¿™ä¸ªæ•°å­—åŒ–ç¯å¢ƒä¸­ç©¿è¡Œæ—¶ï¼ŒåŸ¹å…»æ•°å­—ç´ å…»å¹¶ä¿æŒæŠ€æœ¯é‡‡ç”¨çš„å¹³è¡¡æ–¹æ³•å˜å¾—è‡³å…³é‡è¦ã€‚å…³é”®ä¸åœ¨äºé¿å…æŠ€æœ¯ï¼Œè€Œåœ¨äºäº†è§£å¦‚ä½•åˆ©ç”¨å…¶ä¼˜åŠ¿åŒæ—¶å‡è½»å…¶æ½œåœ¨ç¼ºç‚¹ã€‚'
            }
          ]
        }
      ]
    }

    // éšæœºåŒ–ç­”æ¡ˆé¡ºåº
    const randomizedQuestions = sampleQuestions.map(question => {
      const options = [...question.options]
      const correctAnswer = question.correct_answer

      // æ‰“ä¹±é€‰é¡¹é¡ºåº
      for (let i = options.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [options[i], options[j]] = [options[j], options[i]]
      }

      // æ‰¾åˆ°æ­£ç¡®ç­”æ¡ˆçš„æ–°ä½ç½®
      const newCorrectAnswer = options.find(option =>
        option.charAt(0) === correctAnswer
      )?.charAt(0) || correctAnswer

      return {
        ...question,
        options: options,
        correct_answer: newCorrectAnswer
      }
    })

    this.setData({
      questions: randomizedQuestions,
      passages: samplePassages,
      isLoading: false,
      'stats.total': randomizedQuestions.length
    })
  },

  startTimer() {
    // å¼€å§‹è®¡æ—¶
    this.data.timer = setInterval(() => {
      const timeSpent = Math.floor((Date.now() - this.data.startTime) / 1000)
      const minutes = Math.floor(timeSpent / 60)
      const seconds = timeSpent % 60
      const formattedTime = `${minutes}:${seconds.toString().padStart(2, '0')}`

      this.setData({
        timeSpent,
        formattedTime
      })
    }, 1000)
  },

  // é€‰æ‹©ç­”æ¡ˆ
  selectAnswer(e) {
    const { option } = e.currentTarget.dataset
    const { currentQuestionIndex, questions } = this.data
    const currentQuestion = questions[currentQuestionIndex]

    console.log('ğŸ” é€‰æ‹©ç­”æ¡ˆ:', { questionId: currentQuestion.id, option }) // è°ƒè¯•ä¿¡æ¯

    // æ£€æŸ¥ç­”æ¡ˆæ˜¯å¦æ­£ç¡®
    const isCorrect = option === currentQuestion.correct_answer
    const timeSpent = Math.floor((Date.now() - this.data.startTime) / 1000 / questions.length)

    // è®°å½•åˆ°è¿›åº¦è·Ÿè¸ªå™¨
    progressTracker.recordAnswer(
      currentQuestion.id,
      option,
      currentQuestion.correct_answer,
      isCorrect,
      timeSpent
    )

    // æ›´æ–°ç”¨æˆ·ç­”æ¡ˆ
    const userAnswers = { ...this.data.userAnswers }
    const wasAnswered = !!userAnswers[currentQuestion.id]
    userAnswers[currentQuestion.id] = option

    // æ›´æ–°ç»Ÿè®¡
    const stats = { ...this.data.stats }
    if (!wasAnswered) {
      stats.answered += 1
    }
    if (isCorrect && !wasAnswered) {
      stats.correct += 1
    } else if (!isCorrect && wasAnswered && userAnswers[currentQuestion.id] === currentQuestion.correct_answer) {
      stats.correct -= 1
    } else if (isCorrect && wasAnswered && userAnswers[currentQuestion.id] !== currentQuestion.correct_answer) {
      stats.correct += 1
    }

    // é‡æ–°è®¡ç®—å‡†ç¡®ç‡
    stats.accuracy = stats.answered > 0 ? ((stats.correct / stats.answered) * 100).toFixed(1) : 0

    this.setData({
      userAnswers,
      stats
    })

    // ä¿å­˜ç»ƒä¹ è¿›åº¦
    practiceProgressManager.saveProgress({
      paperId: this.data.paperId,
      type: this.data.practiceType,
      typeName: this.data.paper?.title || this.data.practiceType,
      questionIndex: this.data.currentQuestionIndex,
      userAnswers: this.data.userAnswers,
      startTime: this.data.startTime
    })

    // æ˜¾ç¤ºå³æ—¶åé¦ˆ
    if (this.data.practiceMode === 'practice') {
      const feedbackMsg = isCorrect ? 'âœ… å›ç­”æ­£ç¡®ï¼' : `âŒ æ­£ç¡®ç­”æ¡ˆæ˜¯ ${currentQuestion.correct_answer}`
      wx.showToast({
        title: feedbackMsg,
        icon: 'none',
        duration: 1500
      })
    }
  },

  // ä¸Šä¸€é¢˜
  prevQuestion() {
    const { currentQuestionIndex } = this.data
    if (currentQuestionIndex > 0) {
      this.setData({
        currentQuestionIndex: currentQuestionIndex - 1,
        showExplanation: false
      })
    }
  },

  // ä¸‹ä¸€é¢˜
  nextQuestion() {
    const { currentQuestionIndex, questions } = this.data
    if (currentQuestionIndex < questions.length - 1) {
      this.setData({
        currentQuestionIndex: currentQuestionIndex + 1,
        showExplanation: false
      })
    }
  },

  // è·³è½¬åˆ°æŒ‡å®šé¢˜ç›®
  goToQuestion(e) {
    const { index } = e.currentTarget.dataset
    this.setData({
      currentQuestionIndex: parseInt(index),
      showExplanation: false
    })
  },

  // åˆ‡æ¢è§£ææ˜¾ç¤º
  toggleExplanation() {
    this.setData({
      showExplanation: !this.data.showExplanation
    })
  },

  // æäº¤ç­”æ¡ˆ
  async submitAnswers() {
    const { questions, userAnswers, stats } = this.data

    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é¢˜ç›®éƒ½å·²å›ç­”
    if (stats.answered < stats.total) {
      wx.showModal({
        title: 'æç¤º',
        content: `è¿˜æœ‰ ${stats.total - stats.answered} é“é¢˜ç›®æœªå›ç­”ï¼Œç¡®å®šè¦æäº¤å—ï¼Ÿ`,
        success: (res) => {
          if (res.confirm) {
            this.processResults()
          }
        }
      })
    } else {
      this.processResults()
    }
  },

  // å¤„ç†ç­”é¢˜ç»“æœ
  async processResults() {
    showLoading('æ­£åœ¨è®¡ç®—ç»“æœ...')

    const { questions, userAnswers, timeSpent, paperId } = this.data
    let correctCount = 0
    let evidenceHitCount = 0

    // è®¡ç®—æ­£ç¡®ç­”æ¡ˆæ•°å’Œè¯æ®å‘½ä¸­æ•°
    for (const question of questions) {
      const userAnswer = userAnswers[question.id]
      const isCorrect = userAnswer === question.correct_answer

      if (isCorrect) {
        correctCount++
      }

      // æ¨¡æ‹Ÿè¯æ®å‘½ä¸­ç‡ï¼ˆå®é™…åº”è¯¥æ ¹æ®ç”¨æˆ·çš„é˜…è¯»è¡Œä¸ºåˆ¤æ–­ï¼‰
      if (Math.random() > 0.3) {
        evidenceHitCount++
      }
    }

    const accuracy = ((correctCount / questions.length) * 100).toFixed(1)
    const evidenceHitRate = ((evidenceHitCount / questions.length) * 100).toFixed(1)

    // å®Œæˆå­¦ä¹ ä¼šè¯å¹¶è·å–è¯¦ç»†ç»Ÿè®¡
    const finalStats = {
      evidenceHitRate: parseFloat(evidenceHitRate),
      questionTypes: this.analyzeQuestionTypes(questions, userAnswers),
      studyEfficiency: this.calculateStudyEfficiency(timeSpent, correctCount, questions.length),
      improvementSuggestions: this.generateImprovementSuggestions(accuracy, evidenceHitRate, timeSpent)
    }

    try {
      const sessionResult = await progressTracker.completeSession(finalStats)

      if (sessionResult) {
        // æ˜¾ç¤ºè¯¦ç»†å®Œæˆåé¦ˆ
        this.showCompletionCelebration(sessionResult)

        this.setData({
          showResult: true,
          sessionResult: sessionResult,
          'stats.correct': correctCount,
          'stats.accuracy': accuracy,
          'stats.evidenceHitRate': evidenceHitRate
        })
      }
      
      // æ¸…é™¤ç»ƒä¹ è¿›åº¦ï¼ˆç»ƒä¹ å·²å®Œæˆï¼‰
      practiceProgressManager.clearProgress()
    } catch (error) {
      console.error('å®Œæˆå­¦ä¹ ä¼šè¯å¤±è´¥:', error)
      // é™çº§å¤„ç†ï¼šç›´æ¥æ˜¾ç¤ºç»“æœ
      this.setData({
        showResult: true,
        'stats.correct': correctCount,
        'stats.accuracy': accuracy,
        'stats.evidenceHitRate': evidenceHitRate
      })
      
      // æ¸…é™¤ç»ƒä¹ è¿›åº¦ï¼ˆç»ƒä¹ å·²å®Œæˆï¼‰
      practiceProgressManager.clearProgress()
    }

    hideLoading()
  },

  // æ˜¾ç¤ºå®Œæˆåº†ç¥åŠ¨ç”»å’Œåé¦ˆ
  showCompletionCelebration(sessionResult) {
    const { accuracy, totalQuestions, correctAnswers, totalTimeSpent } = sessionResult

    // æ ¹æ®æˆç»©æ˜¾ç¤ºä¸åŒçš„åº†ç¥ä¿¡æ¯
    let celebrationMsg = ''
    let celebrationIcon = ''

    if (accuracy >= 90) {
      celebrationMsg = 'ğŸ‰ ä¼˜ç§€ï¼è¿‘ä¹å®Œç¾çš„è¡¨ç°ï¼'
      celebrationIcon = 'success'
    } else if (accuracy >= 80) {
      celebrationMsg = 'ğŸŒŸ å¾ˆæ£’ï¼ç»§ç»­ä¿æŒï¼'
      celebrationIcon = 'success'
    } else if (accuracy >= 70) {
      celebrationMsg = 'ğŸ‘ ä¸é”™ï¼è¿˜æœ‰æå‡ç©ºé—´ï¼'
      celebrationIcon = 'none'
    } else if (accuracy >= 60) {
      celebrationMsg = 'ğŸ’ª åŠ æ²¹ï¼å¤šç»ƒä¹ ä¼šæ›´å¥½ï¼'
      celebrationIcon = 'none'
    } else {
      celebrationMsg = 'ğŸ“š ç»§ç»­åŠªåŠ›ï¼ç†Ÿèƒ½ç”Ÿå·§ï¼'
      celebrationIcon = 'none'
    }

    // æ˜¾ç¤ºå³æ—¶åé¦ˆ
    wx.showToast({
      title: celebrationMsg,
      icon: celebrationIcon,
      duration: 2000
    })

    // æ˜¾ç¤ºè¯¦ç»†æˆå°±å¼¹çª—
    setTimeout(() => {
      this.showAchievementModal(sessionResult)
    }, 2000)
  },

  // æ˜¾ç¤ºæˆå°±è¯¦æƒ…å¼¹çª—
  showAchievementModal(sessionResult) {
    const { accuracy, totalQuestions, correctAnswers, totalTimeSpent } = sessionResult
    const timeMinutes = Math.floor(totalTimeSpent / 60)
    const timeSeconds = totalTimeSpent % 60

    const achievementBadges = []

    // æ ¹æ®è¡¨ç°ç»™äºˆå¾½ç« 
    if (accuracy >= 95) {achievementBadges.push('ğŸ† å®Œç¾ä¸»ä¹‰è€…')}
    if (accuracy >= 90) {achievementBadges.push('â­ å­¦éœ¸')}
    if (accuracy >= 80) {achievementBadges.push('ğŸ“š å¥½å­¦è€…')}
    if (totalTimeSpent < 300) {achievementBadges.push('âš¡ ç¥é€Ÿç­”é¢˜')}
    if (totalTimeSpent > 1800) {achievementBadges.push('ğŸŒ æ·±åº¦æ€è€ƒè€…')}
    if (correctAnswers === totalQuestions) {achievementBadges.push('ğŸ¯ ç™¾å‘ç™¾ä¸­')}

    const modalContent = `
æœ¬æ¬¡ç»ƒä¹ ç»Ÿè®¡ï¼š
â€¢ æ­£ç¡®ç‡ï¼š${accuracy}%
â€¢ ç­”å¯¹é¢˜ç›®ï¼š${correctAnswers}/${totalQuestions}
â€¢ ç”¨æ—¶ï¼š${timeMinutes}åˆ†${timeSeconds}ç§’
${achievementBadges.length > 0 ? `\nğŸ… è·å¾—å¾½ç« ï¼š\n${achievementBadges.join('\n')}` : ''}
    `.trim()

    wx.showModal({
      title: 'ğŸŠ ç»ƒä¹ å®Œæˆï¼',
      content: modalContent,
      showCancel: false,
      confirmText: 'æŸ¥çœ‹è¯¦æƒ…',
      success: () => {
        // å¯ä»¥è·³è½¬åˆ°è¯¦ç»†åˆ†æé¡µé¢
        console.log('ç”¨æˆ·æŸ¥çœ‹è¯¦ç»†æˆç»©')
      }
    })
  },

  // åˆ†æé¢˜ç›®ç±»å‹è¡¨ç°
  analyzeQuestionTypes(questions, userAnswers) {
    const typeStats = {}

    questions.forEach(question => {
      const type = question.type || 'unknown'
      const userAnswer = userAnswers[question.id]
      const isCorrect = userAnswer === question.correct_answer

      if (!typeStats[type]) {
        typeStats[type] = { total: 0, correct: 0 }
      }

      typeStats[type].total += 1
      if (isCorrect) {
        typeStats[type].correct += 1
      }
    })

    return typeStats
  },

  // è®¡ç®—å­¦ä¹ æ•ˆç‡
  calculateStudyEfficiency(timeSpent, correctCount, totalQuestions) {
    const avgTimePerQuestion = timeSpent / totalQuestions
    const accuracy = correctCount / totalQuestions

    // ç®€åŒ–çš„æ•ˆç‡ç®—æ³•ï¼šå‡†ç¡®ç‡ / å¹³å‡ç­”é¢˜æ—¶é—´
    const efficiency = accuracy / (avgTimePerQuestion / 60) // æ¯åˆ†é’Ÿæ­£ç¡®é¢˜æ•°

    return {
      avgTimePerQuestion: Math.round(avgTimePerQuestion),
      efficiency: efficiency.toFixed(2)
    }
  },

  // ç”Ÿæˆæ”¹è¿›å»ºè®®
  generateImprovementSuggestions(accuracy, evidenceHitRate, timeSpent) {
    const suggestions = []

    if (accuracy < 70) {
      suggestions.push('å»ºè®®åŠ å¼ºåŸºç¡€çŸ¥è¯†ç»ƒä¹ ')
    }
    if (evidenceHitRate < 60) {
      suggestions.push('æ³¨æ„æé«˜å®šä½è¯æ®å¥çš„èƒ½åŠ›')
    }
    if (timeSpent < 180) {
      suggestions.push('å¯ä»¥é€‚å½“æ”¾æ…¢é€Ÿåº¦ï¼Œä»”ç»†æ€è€ƒ')
    }
    if (timeSpent > 900) {
      suggestions.push('å¯ä»¥å°è¯•æé«˜ç­”é¢˜é€Ÿåº¦')
    }

    return suggestions
  },

  // ä¿å­˜å­¦ä¹ è®°å½•
  async saveStudyRecord(record) {
    try {
      await studyRecordDB.add(record)
      console.log('âœ… ç­”é¢˜è®°å½•ä¿å­˜æˆåŠŸ')
    } catch (error) {
      console.error('âŒ ç­”é¢˜è®°å½•ä¿å­˜å¤±è´¥:', error)
      throw error
    }
  },

  // è·å–é”™è¯¯ç±»å‹ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
  getErrorType(question, userAnswer) {
    if (!userAnswer) {return 'no_answer'}

    // ç®€åŒ–çš„é”™è¯¯ç±»å‹åˆ¤æ–­é€»è¾‘
    const errorTypes = ['scope_expansion', 'extreme_words', 'detail_error', 'inference_error', 'attitude_misjudge']
    return errorTypes[Math.floor(Math.random() * errorTypes.length)]
  },

  // é‡æ–°å¼€å§‹
  restartPractice() {
    // é‡æ–°éšæœºåŒ–ç­”æ¡ˆé¡ºåº
    const randomizedQuestions = this.data.questions.map(question => {
      const options = [...question.options]
      const correctAnswer = question.correct_answer

      // æ‰“ä¹±é€‰é¡¹é¡ºåº
      for (let i = options.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [options[i], options[j]] = [options[j], options[i]]
      }

      // æ‰¾åˆ°æ­£ç¡®ç­”æ¡ˆçš„æ–°ä½ç½®
      const newCorrectAnswer = options.find(option =>
        option.charAt(0) === correctAnswer
      )?.charAt(0) || correctAnswer

      return {
        ...question,
        options: options,
        correct_answer: newCorrectAnswer
      }
    })

    this.setData({
      currentQuestionIndex: 0,
      userAnswers: {},
      showResult: false,
      showExplanation: false,
      startTime: Date.now(),
      timeSpent: 0,
      formattedTime: '0:00',
      'stats.answered': 0,
      'stats.correct': 0,
      'stats.accuracy': 0,
      questions: randomizedQuestions
    })

    // é‡æ–°å¼€å§‹å­¦ä¹ ä¼šè¯
    this.startNewSession(this.data.paperId)
  },

  // éšæœºåŒ–å½“å‰é¢˜ç›®ç­”æ¡ˆé¡ºåº
  randomizeCurrentQuestion() {
    const { currentQuestionIndex, questions } = this.data
    const currentQuestion = questions[currentQuestionIndex]

    if (!currentQuestion) {return}

    const options = [...currentQuestion.options]
    const correctAnswer = currentQuestion.correct_answer

    // æ‰“ä¹±é€‰é¡¹é¡ºåº
    for (let i = options.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [options[i], options[j]] = [options[j], options[i]]
    }

    // æ‰¾åˆ°æ­£ç¡®ç­”æ¡ˆçš„æ–°ä½ç½®
    const newCorrectAnswer = options.find(option =>
      option.charAt(0) === correctAnswer
    )?.charAt(0) || correctAnswer

    // æ›´æ–°é¢˜ç›®
    const updatedQuestions = [...questions]
    updatedQuestions[currentQuestionIndex] = {
      ...currentQuestion,
      options: options,
      correct_answer: newCorrectAnswer
    }

    this.setData({
      questions: updatedQuestions
    })

    wx.showToast({
      title: 'å·²é‡æ–°æ’åˆ—é€‰é¡¹',
      icon: 'none',
      duration: 1000
    })
  },

  // æŸ¥çœ‹è¯¦ç»†ç»“æœ
  viewDetailedResults() {
    // è·³è½¬åˆ°æŠ¥å‘Šé¡µé¢æŸ¥çœ‹è¯¦ç»†åˆ†æ
    wx.navigateTo({
      url: '/pages/report/report'
    })
  },

  // è¿”å›é¦–é¡µ
  goBack() {
    wx.navigateBack({
      fail: () => {
        wx.switchTab({
          url: '/pages/home/home'
        })
      }
    })
  },

  // ==================== AI æç¤ºç›¸å…³æ–¹æ³• ====================

  /**
   * è§¦å‘ AI æç¤ºç”Ÿæˆ
   */
  async triggerAIHint() {
    try {
      console.log('ğŸ¤– è§¦å‘ AI æç¤ºç”Ÿæˆ...')

      // è·å–å½“å‰é¢˜ç›®ä¿¡æ¯
      const questionType = this.data.practiceType || 'reading'
      const currentQuestion = this.getCurrentQuestionInfo()

      if (!currentQuestion) {
        console.warn('âš ï¸ æ— æ³•è·å–å½“å‰é¢˜ç›®ä¿¡æ¯')
        return
      }

      // è°ƒç”¨ AI ç”Ÿæˆæç¤º
      const hint = await this.aiHintGenerator.generate({
        questionType: questionType,
        skill: this.getQuestionSkill(questionType),
        materialText: currentQuestion.material || '',
        question: currentQuestion.question || '',
        options: currentQuestion.options || []
      })

      // æ›´æ–° UI
      this.setData({
        showHint: true,
        hintMessage: hint.focus,
        hintPoints: hint.scaffold || [],
        hintKeywords: hint.keywords || [],
        hintAutoExpand: false
      })

      console.log('âœ… AI æç¤ºç”ŸæˆæˆåŠŸ', hint)

    } catch (error) {
      console.error('âŒ AI æç¤ºç”Ÿæˆå¤±è´¥:', error)
      // å¤±è´¥æ—¶ä½¿ç”¨é™çº§æ¨¡æ¿ï¼ˆå·²åœ¨ AIHintGenerator å†…éƒ¨å¤„ç†ï¼‰
    }
  },

  /**
   * è·å–å½“å‰é¢˜ç›®ä¿¡æ¯
   */
  getCurrentQuestionInfo() {
    const { practiceType, currentPassage, clozeData, questions, currentQuestionIndex } = this.data

    if (practiceType === 'reading' && currentPassage) {
      return {
        material: currentPassage.content,
        question: questions[currentQuestionIndex]?.stem || '',
        options: questions[currentQuestionIndex]?.options || []
      }
    } else if (practiceType === 'cloze' && clozeData) {
      return {
        material: clozeData.passage,
        question: `å¡«ç©ºç¬¬ ${currentQuestionIndex + 1} ä¸ªç©ºæ ¼`,
        options: clozeData.questions[currentQuestionIndex]?.options || []
      }
    }

    return null
  },

  /**
   * æ ¹æ®é¢˜å‹ç¡®å®š skill
   */
  getQuestionSkill(questionType) {
    const skillMap = {
      'reading': 'reading.detail',
      'cloze': 'cloze.logic',
      'translation': 'translation.syntax',
      'writing': 'writing.structure'
    }
    return skillMap[questionType] || 'reading.detail'
  },

  /**
   * æç¤ºå¡ç‰‡å±•å¼€äº‹ä»¶
   */
  onHintExpand() {
    console.log('ğŸ‘ï¸ ç”¨æˆ·å±•å¼€æç¤º')
    // å¯ä»¥è®°å½•ç”¨æˆ·è¡Œä¸º
  },

  /**
   * æç¤ºå¡ç‰‡æ”¶èµ·äº‹ä»¶
   */
  onHintCollapse() {
    console.log('ğŸ‘ï¸ ç”¨æˆ·æ”¶èµ·æç¤º')
    this.setData({ showHint: false })
  },

  /**
   * ç”¨æˆ·ä½œç­”æ—¶é‡ç½®ç©ºé—²æ—¶é—´
   */
  onUserInteraction() {
    this.setData({
      idleTime: 0,
      attempts: this.data.attempts + 1
    })
  },

  onUnload() {
    // æ¸…ç†å®šæ—¶å™¨
    if (this.timer) {
      clearInterval(this.timer)
    }
    if (this.idleTimer) {
      clearInterval(this.idleTimer)
    }
  },

  // æ£€æŸ¥ä¸»é¢˜è®¾ç½®
  checkThemeSetup() {
    // æ£€æŸ¥æ˜¯å¦å·²ç»è®¾ç½®è¿‡ä¸»é¢˜
    const hasSeenThemeSetup = wx.getStorageSync('hasSeenThemeSetup')

    if (!hasSeenThemeSetup) {
      // è·å–ç³»ç»Ÿä¸»é¢˜
      const systemTheme = themeUtils.getSystemTheme()

      // å»¶è¿Ÿæ˜¾ç¤ºï¼Œè®©é¡µé¢å…ˆåŠ è½½å®Œæˆ
      setTimeout(() => {
        this.setData({
          showThemeSetup: true,
          systemTheme
        })
      }, 1000)
    }
  },

  // ä¸»é¢˜è®¾ç½®ç¡®è®¤
  onThemeSetupConfirm(e) {
    const { theme, followSystem } = e.detail

    // æ ¹æ®ç”¨æˆ·é€‰æ‹©è®¾ç½®ä¸»é¢˜
    if (followSystem) {
      themeUtils.setFollowSystem(true)
    } else {
      themeUtils.setUserTheme(theme)
    }

    // æ ‡è®°é¦–æ¬¡è®¾ç½®å·²å®Œæˆ
    themeUtils.markFirstTimeSetupComplete()
    wx.setStorageSync('hasSeenThemeSetup', true)

    // å…³é—­å¼¹çª—
    this.setData({
      showThemeSetup: false
    })

    console.log('âœ… ä¸»é¢˜è®¾ç½®å®Œæˆ:', { theme, followSystem })
  },

  // å…³é—­ä¸»é¢˜è®¾ç½®
  onThemeSetupClose() {
    // æ ‡è®°å·²æŸ¥çœ‹
    wx.setStorageSync('hasSeenThemeSetup', true)

    this.setData({
      showThemeSetup: false
    })
  }
})
