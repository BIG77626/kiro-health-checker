// pages/profile/profile.js
const { CloudDatabase } = require('../../utils/cloud.js')
const { showSuccess, showError, getDaysDiff } = require('../../utils/util.js')
const themeUtils = require('../../utils/theme.js')

// æ¶æ„åˆ‡æ¢å¼€å…³ï¼ˆå¾®ä¿¡å°ç¨‹åºç¯å¢ƒå…¼å®¹å¤„ç†ï¼‰
// åœ¨å¾®ä¿¡å°ç¨‹åºä¸­æ²¡æœ‰processå¯¹è±¡ï¼Œä½¿ç”¨æ¡ä»¶ç¼–è¯‘æˆ–é…ç½®
let USE_NEW_ARCHITECTURE = true // ä½¿ç”¨letè€Œä¸æ˜¯constï¼Œå…è®¸é™çº§

// æ–°æ¶æ„ç›¸å…³å¯¼å…¥ï¼ˆæ¡ä»¶åŠ è½½ï¼‰
let ProfileViewModel = null
let createProfileContainer = null

if (USE_NEW_ARCHITECTURE) {
  try {
    ProfileViewModel = require('./ProfileViewModel')
    createProfileContainer = require('../../core/infrastructure/di/profileContainer')
    console.log('âœ… Profileé¡µé¢ï¼šå¯ç”¨æ–°æ¶æ„ (Clean Architecture)')
  } catch (error) {
    console.warn('âš ï¸ Profileé¡µé¢ï¼šæ–°æ¶æ„ç»„ä»¶åŠ è½½å¤±è´¥ï¼Œå›é€€åˆ°æ—§æ¶æ„', error.message)
    USE_NEW_ARCHITECTURE = false
  }
} else {
  console.log('ğŸ“‹ Profileé¡µé¢ï¼šä½¿ç”¨æ—§æ¶æ„ (ä¼ ç»Ÿæ¨¡å¼)')
}

// åˆå§‹åŒ–æ•°æ®åº“ï¼ˆæ—§æ¶æ„ä½¿ç”¨ï¼‰
const studyRecordDB = USE_NEW_ARCHITECTURE ? null : new CloudDatabase('studyrecords')

Page({
  __loadStartTime: Date.now(),
  data: {
    userInfo: {},
    hasLogin: false,
    studyDays: 0,
    achievements: {
      totalStudyTime: 0,
      totalQuestions: 0,
      bestAccuracy: 0
    },
    showAboutModal: false,
    version: '1.0.0',
    showThemeSetup: false,
    systemTheme: 'light',
    // æ–°æ¶æ„çŠ¶æ€
    isNewArchitecture: USE_NEW_ARCHITECTURE,
    viewModelError: null
  },

  onLoad(options) {
    console.log('ã€ä¸ªäººä¸­å¿ƒã€‘é¡µé¢åŠ è½½', options)

    if (USE_NEW_ARCHITECTURE) {
      // æ–°æ¶æ„åˆå§‹åŒ–
      this._initNewArchitecture()
    } else {
      // æ—§æ¶æ„åˆå§‹åŒ–
      this._initLegacyArchitecture()
    }
  },

  /**
   * æ–°æ¶æ„åˆå§‹åŒ–
   * @private
   */
  _initNewArchitecture() {
    try {
      console.log('ğŸš€ Profileé¡µé¢ï¼šåˆå§‹åŒ–æ–°æ¶æ„...')

      // åˆ›å»ºDIå®¹å™¨
      this.container = createProfileContainer('wechat')

      // åˆ›å»ºViewModel
      this.viewModel = this.container.resolve('profileViewModel')

      // è®¢é˜…çŠ¶æ€å˜åŒ–
      this.unsubscribe = this.viewModel.subscribe((state) => {
        this.setData({
          userInfo: state.userInfo,
          hasLogin: state.hasLogin,
          studyDays: state.studyDays,
          achievements: state.achievements,
          viewModelError: state.error
        })
      })

      // åˆå§‹åŒ–æ•°æ®åŠ è½½
      this._loadNewArchitectureData()

    } catch (error) {
      console.error('âŒ Profileé¡µé¢ï¼šæ–°æ¶æ„åˆå§‹åŒ–å¤±è´¥', error)
      this.setData({
        viewModelError: error.message,
        isNewArchitecture: false
      })
      // å›é€€åˆ°æ—§æ¶æ„
      this._initLegacyArchitecture()
    }
  },

  /**
   * æ—§æ¶æ„åˆå§‹åŒ–
   * @private
   */
  _initLegacyArchitecture() {
    console.log('ğŸ“‹ Profileé¡µé¢ï¼šåˆå§‹åŒ–æ—§æ¶æ„...')

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    this.checkLoginStatus()

    // åŠ è½½ç”¨æˆ·æ•°æ®
    this.loadUserData()
  },

  /**
   * æ–°æ¶æ„æ•°æ®åŠ è½½
   * @private
   */
  async _loadNewArchitectureData() {
    try {
      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      await this.viewModel.checkLoginStatus()

      // åŠ è½½ç”¨æˆ·æ•°æ®
      await this.viewModel.loadUserData()

    } catch (error) {
      console.error('âŒ Profileé¡µé¢ï¼šæ–°æ¶æ„æ•°æ®åŠ è½½å¤±è´¥', error)
      this.setData({
        viewModelError: error.message
      })
    }
  },

  onReady() {
    // æ€§èƒ½è·Ÿè¸ª
    const app = getApp()
    if (app.globalData && app.globalData.perfTest) {
      const loadTime = Date.now() - this.__loadStartTime
      app.globalData.perfTest.recordPagePerformance('profile', { loadTime })
    }

    // é¡µé¢æ¸²æŸ“å®Œæˆ
    console.log('ã€ä¸ªäººä¸­å¿ƒã€‘é¡µé¢æ¸²æŸ“å®Œæˆ')
  },

  onUnload() {
    // æ¸…ç†æ–°æ¶æ„èµ„æº
    if (USE_NEW_ARCHITECTURE && this.unsubscribe) {
      this.unsubscribe()
      this.unsubscribe = null
    }

    if (USE_NEW_ARCHITECTURE && this.viewModel) {
      this.viewModel = null
    }

    if (USE_NEW_ARCHITECTURE && this.container) {
      this.container = null
    }

    console.log('ã€ä¸ªäººä¸­å¿ƒã€‘é¡µé¢å¸è½½ï¼Œèµ„æºå·²æ¸…ç†')
  },

  onShow() {
    this.loadUserData()
    this.checkThemeSetup()
  },

  checkLoginStatus() {
    // æ–°æ¶æ„ä¸­ï¼Œæ­¤æ–¹æ³•å·²åºŸå¼ƒï¼Œç”±ViewModel.checkLoginStatus()æ›¿ä»£
    console.log('ã€åºŸå¼ƒæ–¹æ³•ã€‘checkLoginStatusåœ¨æ–°æ¶æ„ä¸­ä¸å†ä½¿ç”¨')
  },


  async loadUserData() {
    try {
      // åŠ è½½å­¦ä¹ æ•°æ®
      const studyRecords = await studyRecordDB.list('-created_date', 1000)

      if (studyRecords.length > 0) {
        // è®¡ç®—å­¦ä¹ å¤©æ•°
        const firstStudyDate = new Date(studyRecords[studyRecords.length - 1].created_date)
        const studyDays = getDaysDiff(new Date(), firstStudyDate) + 1

        // è®¡ç®—æˆå°±æ•°æ®
        const totalStudyTime = Math.round(
          studyRecords.reduce((sum, record) => sum + (record.time_spent || 0), 0) / 3600
        ) // è½¬æ¢ä¸ºå°æ—¶

        const totalQuestions = studyRecords.length

        // è®¡ç®—æœ€ä½³æ­£ç¡®ç‡ï¼ˆæŒ‰å¤©åˆ†ç»„ï¼‰
        const dailyAccuracy = {}
        studyRecords.forEach(record => {
          if (record.created_date) {
            const date = record.created_date.split('T')[0]
            if (!dailyAccuracy[date]) {
              dailyAccuracy[date] = { correct: 0, total: 0 }
            }
            dailyAccuracy[date].total++
            if (record.is_correct) {
              dailyAccuracy[date].correct++
            }
          }
        })

        const bestAccuracy = Math.max(
          ...Object.values(dailyAccuracy).map(day =>
            day.total > 0 ? Math.round((day.correct / day.total) * 100) : 0
          ),
          0
        )

        this.setData({
          studyDays,
          achievements: {
            totalStudyTime,
            totalQuestions,
            bestAccuracy
          }
        })
      }
    } catch (error) {
      console.error('Failed to load user data:', error)
      // è®¾ç½®é»˜è®¤æ•°æ®
      this.setData({
        studyDays: 1,
        achievements: {
          totalStudyTime: 0,
          totalQuestions: 0,
          bestAccuracy: 0
        }
      })
    }
  },


  async handleLogin() {
    if (USE_NEW_ARCHITECTURE && this.viewModel) {
      // æ–°æ¶æ„ç™»å½•
      return this._handleLoginNew()
    } else {
      // æ—§æ¶æ„ç™»å½•
      return this._handleLoginLegacy()
    }
  },

  /**
   * æ–°æ¶æ„ç™»å½•å¤„ç†
   * @private
   */
  async _handleLoginNew() {
    try {
      // 1. è·å–ç”¨æˆ·æˆæƒ
      const profileRes = await new Promise((resolve, reject) => {
        wx.getUserProfile({
          desc: 'ç”¨äºå®Œå–„ç”¨æˆ·èµ„æ–™å’Œå­¦ä¹ æ•°æ®åŒæ­¥',
          success: resolve,
          fail: reject
        })
      })

      // 2. é€šè¿‡ViewModelå¤„ç†æˆæƒæ•°æ®
      const authResult = await this.viewModel.processUserAuth(profileRes)
      if (!authResult.success) {
        throw new Error(authResult.error)
      }

      // 3. è·å–å¾®ä¿¡ç™»å½•å‡­è¯
      const loginRes = await new Promise((resolve, reject) => {
        wx.login({
          success: resolve,
          fail: reject
        })
      })

      if (!loginRes.code) {
        throw new Error('è·å–å¾®ä¿¡ç™»å½•å‡­è¯å¤±è´¥')
      }

      // 4. è°ƒç”¨ViewModelç™»å½•
      const result = await this.viewModel.login(authResult.profile, loginRes.code)

      if (result.success) {
        showSuccess('ç™»å½•æˆåŠŸ')
        // è§¦å‘æ•°æ®åŒæ­¥
        setTimeout(() => {
          this.handleSyncData()
        }, 100)
      } else {
        showError(result.error || 'ç™»å½•å¤±è´¥')
      }

    } catch (error) {
      console.error('æ–°æ¶æ„ç™»å½•å¤±è´¥:', error)
      showError(error.message || 'ç™»å½•å¤±è´¥')
    }
  },

  /**
   * æ—§æ¶æ„ç™»å½•å¤„ç†
   * @private
   */
  async _handleLoginLegacy() {
    // ğŸ”´ æ¶æ„æ¸…ç†ï¼šæ­¤æ–¹æ³•åœ¨æ–°æ¶æ„ä¸­å·²åºŸå¼ƒï¼Œæ‰€æœ‰wx APIè°ƒç”¨å·²ç§»é™¤
    console.log('âŒ æ­¤æ–¹æ³•åœ¨æ–°æ¶æ„ä¸­å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨æ–°æ¶æ„ç™»å½•')
    throw new Error('æ—§æ¶æ„ç™»å½•å·²ç¦ç”¨ï¼Œè¯·ä½¿ç”¨æ–°æ¶æ„')
  },

  // é€€å‡ºç™»å½•
  handleLogout() {
    if (USE_NEW_ARCHITECTURE && this.viewModel) {
      // æ–°æ¶æ„ç™»å‡º
      return this._handleLogoutNew()
    } else {
      // æ—§æ¶æ„ç™»å‡º
      return this._handleLogoutLegacy()
    }
  },

  /**
   * æ–°æ¶æ„ç™»å‡ºå¤„ç†
   * @private
   */
  _handleLogoutNew() {
    wx.showModal({
      title: 'ç¡®è®¤é€€å‡º',
      content: 'é€€å‡ºç™»å½•åï¼Œæœ¬åœ°å­¦ä¹ æ•°æ®å°†è¢«æ¸…é™¤ï¼Œç¡®å®šè¦é€€å‡ºå—ï¼Ÿ',
      success: async (res) => {
        if (res.confirm) {
          try {
            const result = await this.viewModel.logout()

            if (result.success) {
              showSuccess('å·²é€€å‡ºç™»å½•')
            } else {
              showError(result.error || 'ç™»å‡ºå¤±è´¥')
            }
          } catch (error) {
            console.error('æ–°æ¶æ„ç™»å‡ºå¤±è´¥:', error)
            showError(error.message || 'ç™»å‡ºå¤±è´¥')
          }
        }
      }
    })
  },

  /**
   * æ—§æ¶æ„ç™»å‡ºå¤„ç†
   * @private
   */
  _handleLogoutLegacy() {
    // ğŸ”´ æ¶æ„æ¸…ç†ï¼šæ­¤æ–¹æ³•åœ¨æ–°æ¶æ„ä¸­å·²åºŸå¼ƒï¼Œæ‰€æœ‰wx.removeStorageSyncè°ƒç”¨å·²ç§»é™¤
    console.log('âŒ æ­¤æ–¹æ³•åœ¨æ–°æ¶æ„ä¸­å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨æ–°æ¶æ„ç™»å‡º')
    throw new Error('æ—§æ¶æ„ç™»å‡ºå·²ç¦ç”¨ï¼Œè¯·ä½¿ç”¨æ–°æ¶æ„')
  },


  // ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯
  editUserInfo() {
    if (!this.data.hasLogin) {
      showError('è¯·å…ˆç™»å½•')
      return
    }

    wx.showModal({
      title: 'ç¼–è¾‘èµ„æ–™',
      content: 'åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼',
      showCancel: false
    })
  },

  // æ¸…é™¤ç¼“å­˜
  clearCache() {
    if (USE_NEW_ARCHITECTURE && this.viewModel) {
      // æ–°æ¶æ„ç¼“å­˜æ¸…ç†
      return this._clearCacheNew()
    } else {
      // æ—§æ¶æ„ç¼“å­˜æ¸…ç†
      return this._clearCacheLegacy()
    }
  },

  /**
   * æ–°æ¶æ„ç¼“å­˜æ¸…ç†
   * @private
   */
  _clearCacheNew() {
    wx.showModal({
      title: 'æ¸…é™¤ç¼“å­˜',
      content: 'ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°ç¼“å­˜æ•°æ®å—ï¼Ÿè¿™ä¸ä¼šå½±å“æ‚¨çš„äº‘ç«¯æ•°æ®ã€‚',
      success: async (res) => {
        if (res.confirm) {
          try {
            const result = await this.viewModel.clearCache()

            if (result.success) {
              showSuccess('ç¼“å­˜å·²æ¸…é™¤')
            } else {
              showError(result.error || 'æ¸…é™¤ç¼“å­˜å¤±è´¥')
            }
          } catch (error) {
            console.error('æ–°æ¶æ„æ¸…é™¤ç¼“å­˜å¤±è´¥:', error)
            showError(error.message || 'æ¸…é™¤ç¼“å­˜å¤±è´¥')
          }
        }
      }
    })
  },

  /**
   * æ—§æ¶æ„ç¼“å­˜æ¸…ç†
   * @private
   */
  _clearCacheLegacy() {
    // ğŸ”´ æ¶æ„æ¸…ç†ï¼šæ­¤æ–¹æ³•åœ¨æ–°æ¶æ„ä¸­å·²åºŸå¼ƒï¼Œwx.clearStorageSyncè°ƒç”¨å·²ç§»é™¤
    console.log('âŒ æ­¤æ–¹æ³•åœ¨æ–°æ¶æ„ä¸­å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨æ–°æ¶æ„ç¼“å­˜æ¸…ç†')
    throw new Error('æ—§æ¶æ„ç¼“å­˜æ¸…ç†å·²ç¦ç”¨ï¼Œè¯·ä½¿ç”¨æ–°æ¶æ„')
  },

  // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
  async refreshUserInfo() {
    if (USE_NEW_ARCHITECTURE && this.viewModel) {
      // æ–°æ¶æ„åˆ·æ–°
      return this._refreshUserInfoNew()
    } else {
      // æ—§æ¶æ„åˆ·æ–°
      return this._refreshUserInfoLegacy()
    }
  },

  /**
   * æ–°æ¶æ„åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
   * @private
   */
  async _refreshUserInfoNew() {
    if (!this.data.hasLogin) {
      return
    }

    wx.showLoading({
      title: 'åˆ·æ–°ä¸­...',
      mask: true
    })

    try {
      const result = await this.viewModel.refreshUserInfo()

      if (result.success) {
        showSuccess('å·²åˆ·æ–°')
      } else {
        showError(result.message || 'åˆ·æ–°å¤±è´¥')
      }
    } catch (error) {
      console.error('æ–°æ¶æ„åˆ·æ–°å¤±è´¥:', error)
      showError(error.message || 'åˆ·æ–°å¤±è´¥')
    } finally {
      wx.hideLoading()
    }
  },

  /**
   * æ—§æ¶æ„åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
   * @private
   */
  _refreshUserInfoLegacy() {
    if (!this.data.hasLogin) {
      return
    }

    wx.showLoading({
      title: 'åˆ·æ–°ä¸­...',
      mask: true
    })

    // é‡æ–°æ£€æŸ¥ç™»å½•çŠ¶æ€
    this.checkLoginStatus()

    // é‡æ–°åŠ è½½å­¦ä¹ æ•°æ®
    this.loadUserData()

    setTimeout(() => {
      wx.hideLoading()
      showSuccess('å·²åˆ·æ–°')
    }, 1000)
  },

  // ä¸‹æ‹‰åˆ·æ–°
  onPullDownRefresh() {
    console.log('ã€ä¸‹æ‹‰åˆ·æ–°ã€‘å¼€å§‹')

    if (USE_NEW_ARCHITECTURE && this.viewModel) {
      // æ–°æ¶æ„ä¸‹æ‹‰åˆ·æ–°
      this._pullDownRefreshNew()
    } else {
      // æ—§æ¶æ„ä¸‹æ‹‰åˆ·æ–°
      this._pullDownRefreshLegacy()
    }
  },

  /**
   * æ–°æ¶æ„ä¸‹æ‹‰åˆ·æ–°
   * @private
   */
  async _pullDownRefreshNew() {
    try {
      // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
      await this._loadNewArchitectureData()

      // å»¶è¿Ÿç»“æŸåˆ·æ–°åŠ¨ç”»
      setTimeout(() => {
        wx.stopPullDownRefresh()
        console.log('ã€ä¸‹æ‹‰åˆ·æ–°ã€‘å®Œæˆ')
      }, 1000)
    } catch (error) {
      console.error('æ–°æ¶æ„ä¸‹æ‹‰åˆ·æ–°å¤±è´¥:', error)
      wx.stopPullDownRefresh()
    }
  },

  /**
   * æ—§æ¶æ„ä¸‹æ‹‰åˆ·æ–°
   * @private
   */
  _pullDownRefreshLegacy() {
    // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
    this.checkLoginStatus()
    this.loadUserData()

    // å»¶è¿Ÿç»“æŸåˆ·æ–°åŠ¨ç”»
    setTimeout(() => {
      wx.stopPullDownRefresh()
      console.log('ã€ä¸‹æ‹‰åˆ·æ–°ã€‘å®Œæˆ')
    }, 1500)
  },

  // åŒæ­¥ç”¨æˆ·æ•°æ®
  handleSyncData() {
    if (USE_NEW_ARCHITECTURE && this.viewModel) {
      // æ–°æ¶æ„æ•°æ®åŒæ­¥
      return this._syncDataNew()
    } else {
      // æ—§æ¶æ„æ•°æ®åŒæ­¥
      return this._syncDataLegacy()
    }
  },

  /**
   * æ–°æ¶æ„æ•°æ®åŒæ­¥
   * @private
   */
  async _syncDataNew() {
    try {
      const result = await this.viewModel.syncUserData()

      if (result.success) {
        showSuccess(result.message || 'æ•°æ®åŒæ­¥æˆåŠŸ')
      } else {
        showError(result.error || 'æ•°æ®åŒæ­¥å¤±è´¥')
      }
    } catch (error) {
      console.error('æ–°æ¶æ„æ•°æ®åŒæ­¥å¤±è´¥:', error)
      showError(error.message || 'æ•°æ®åŒæ­¥å¤±è´¥')
    }
  },

  /**
   * æ—§æ¶æ„æ•°æ®åŒæ­¥
   * @private
   */
  async _syncDataLegacy() {
    // ğŸ”´ æ¶æ„æ¸…ç†ï¼šæ­¤æ–¹æ³•åœ¨æ–°æ¶æ„ä¸­å·²åºŸå¼ƒï¼Œwx.getStorageSyncå’Œwx.removeStorageSyncè°ƒç”¨å·²ç§»é™¤
    console.log('âŒ æ­¤æ–¹æ³•åœ¨æ–°æ¶æ„ä¸­å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨æ–°æ¶æ„æ•°æ®åŒæ­¥')
    throw new Error('æ—§æ¶æ„æ•°æ®åŒæ­¥å·²ç¦ç”¨ï¼Œè¯·ä½¿ç”¨æ–°æ¶æ„')
  },


  goToStudySettings() {
    wx.showToast({
      title: 'åŠŸèƒ½å¼€å‘ä¸­...',
      icon: 'none'
    })
  },

  goToStudyHistory() {
    wx.showToast({
      title: 'åŠŸèƒ½å¼€å‘ä¸­...',
      icon: 'none'
    })
  },

  goToFeedback() {
    wx.showModal({
      title: 'æ„è§åé¦ˆ',
      content: 'è¯·é€šè¿‡é‚®ç®± feedback@example.com è”ç³»æˆ‘ä»¬ï¼Œæˆ–åœ¨åº”ç”¨å•†åº—ç•™ä¸‹è¯„ä»·ã€‚',
      showCancel: false,
      confirmText: 'çŸ¥é“äº†'
    })
  },

  showAbout() {
    this.setData({ showAboutModal: true })
  },

  hideAbout() {
    this.setData({ showAboutModal: false })
  },

  showAllAchievements() {
    wx.showToast({
      title: 'åŠŸèƒ½å¼€å‘ä¸­...',
      icon: 'none'
    })
  },

  // æ£€æŸ¥ä¸»é¢˜è®¾ç½®
  async checkThemeSetup() {
    try {
      // é€šè¿‡ViewModelæ£€æŸ¥ä¸»é¢˜è®¾ç½®çŠ¶æ€
      const themeSetupStatus = await this.viewModel.checkThemeSetupStatus()

      if (!themeSetupStatus.hasSeen) {
        // è·å–ç³»ç»Ÿä¸»é¢˜
        const systemTheme = themeUtils.getSystemTheme()

        // å»¶è¿Ÿæ˜¾ç¤ºï¼Œè®©é¡µé¢å…ˆåŠ è½½å®Œæˆ
        setTimeout(() => {
          this.setData({
            showThemeSetup: true,
            systemTheme
          })
        }, 1000)
      }
    } catch (error) {
      console.error('æ£€æŸ¥ä¸»é¢˜è®¾ç½®å¤±è´¥:', error)
      // é™çº§å¤„ç†ï¼šå‡è®¾æœªè®¾ç½®
      const systemTheme = themeUtils.getSystemTheme()
      setTimeout(() => {
        this.setData({
          showThemeSetup: true,
          systemTheme
        })
      }, 1000)
    }
  },

  // ä¸»é¢˜è®¾ç½®ç¡®è®¤
  async onThemeSetupConfirm(e) {
    try {
      const { theme, followSystem } = e.detail

      // é€šè¿‡ViewModelè®¾ç½®ä¸»é¢˜
      await this.viewModel.setThemePreference({ theme, followSystem })

      // å…³é—­å¼¹çª—
      this.setData({
        showThemeSetup: false
      })

      console.log('âœ… ä¸»é¢˜è®¾ç½®å®Œæˆ:', { theme, followSystem })
    } catch (error) {
      console.error('ä¸»é¢˜è®¾ç½®å¤±è´¥:', error)
      wx.showToast({
        title: 'ä¸»é¢˜è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•',
        icon: 'none'
      })
    }
  },

  // å…³é—­ä¸»é¢˜è®¾ç½®
  async onThemeSetupClose() {
    try {
      // é€šè¿‡ViewModelæ ‡è®°å·²æŸ¥çœ‹
      await this.viewModel.markThemeSetupViewed()

      this.setData({
        showThemeSetup: false
      })
    } catch (error) {
      console.error('å…³é—­ä¸»é¢˜è®¾ç½®å¤±è´¥:', error)
      // é™çº§å¤„ç†ï¼šç›´æ¥å…³é—­å¼¹çª—
      this.setData({
        showThemeSetup: false
      })
    }
  }
})
