// pages/ai-assistant/ai-assistant.js
Page({
  data: {
    // ä¸»é¢˜ç›¸å…³
    themeClass: '',

    // Tabåˆ‡æ¢
    activeTab: 'chat', // chat æˆ– courses

    // ==================== AIå¯¹è¯ç›¸å…³ ====================
    messages: [],
    inputText: '',
    aiTyping: false,
    scrollToView: '',

    // ç”¨æˆ·å¤´åƒ
    userAvatar: '/images/user-default.png',

    // AIå¤´åƒ
    aiAvatar: '/images/logo.png',

    // å¿«é€Ÿå»ºè®®é—®é¢˜
    quickSuggestions: [
      'æˆ‘å®Œå‹å¡«ç©ºæ€»æ˜¯åšä¸å¥½ï¼Œæ€ä¹ˆåŠï¼Ÿ',
      'å¦‚ä½•å¿«é€Ÿè®°å¿†å•è¯ï¼Ÿ',
      'å¸®æˆ‘åˆ¶å®šä¸€ä¸ªå­¦ä¹ è®¡åˆ’',
      'åˆ†æä¸€ä¸‹æˆ‘çš„å­¦ä¹ æ•°æ®'
    ],

    // å¿«æ·åŠŸèƒ½æŒ‰é’®
    quickActions: [
      {
        id: 1,
        emoji: 'ğŸ“Š',
        label: 'å­¦ä¹ è¯Šæ–­',
        action: 'diagnose'
      },
      {
        id: 2,
        emoji: 'ğŸ’¡',
        label: 'é¢˜ç›®ç­”ç–‘',
        action: 'question_help'
      },
      {
        id: 3,
        emoji: 'ğŸ“š',
        label: 'è¯æ±‡è§£æ',
        action: 'vocabulary_help'
      },
      {
        id: 4,
        emoji: 'ğŸ“…',
        label: 'åˆ¶å®šè®¡åˆ’',
        action: 'make_plan'
      },
      {
        id: 5,
        emoji: 'ğŸ¯',
        label: 'å­¦ä¹ å»ºè®®',
        action: 'advice'
      },
      {
        id: 6,
        emoji: 'ğŸ’ª',
        label: 'å¿ƒç†è¾…å¯¼',
        action: 'psychology'
      }
    ],

    // ==================== è¯¾ç¨‹ç›¸å…³ ====================
    selectedCategory: 'all',

    courseCategories: [
      { id: 'all', name: 'å…¨éƒ¨' },
      { id: 'reading', name: 'é˜…è¯»ç†è§£' },
      { id: 'cloze', name: 'å®Œå‹å¡«ç©º' },
      { id: 'translation', name: 'ç¿»è¯‘å†™ä½œ' },
      { id: 'vocabulary', name: 'è¯æ±‡è¯­æ³•' }
    ],

    courses: [
      {
        id: 1,
        title: '2024å¹´è€ƒç ”è‹±è¯­é˜…è¯»çœŸé¢˜ç²¾è®²',
        instructor: 'å¼ è€å¸ˆ',
        category: 'reading',
        rating: 4.9,
        students: 1258,
        lessons: 20,
        duration: '10å°æ—¶',
        difficulty: 'â˜…â˜…â˜…â˜…â˜†',
        progress: 25,
        cover: ''
      },
      {
        id: 2,
        title: 'å®Œå‹å¡«ç©ºé«˜åˆ†æŠ€å·§çªç ´',
        instructor: 'æè€å¸ˆ',
        category: 'cloze',
        rating: 4.8,
        students: 856,
        lessons: 15,
        duration: '8å°æ—¶',
        difficulty: 'â˜…â˜…â˜…â˜†â˜†',
        progress: 0,
        cover: ''
      },
      {
        id: 3,
        title: 'è€ƒç ”è‹±è¯­è¯æ±‡è®°å¿†æ³•',
        instructor: 'ç‹è€å¸ˆ',
        category: 'vocabulary',
        rating: 4.7,
        students: 2134,
        lessons: 30,
        duration: '15å°æ—¶',
        difficulty: 'â˜…â˜…â˜†â˜†â˜†',
        progress: 60,
        cover: ''
      },
      {
        id: 4,
        title: 'è‹±è¯‘æ±‰ç¿»è¯‘æŠ€å·§ç²¾è®²',
        instructor: 'èµµè€å¸ˆ',
        category: 'translation',
        rating: 4.9,
        students: 745,
        lessons: 12,
        duration: '6å°æ—¶',
        difficulty: 'â˜…â˜…â˜…â˜…â˜†',
        progress: 0,
        cover: ''
      }
    ],

    filteredCourses: []
  },

  onLoad(options) {
    this.setData({
      filteredCourses: this.data.courses
    })

    // å¦‚æœæœ‰ä¼ å…¥çš„é—®é¢˜ï¼Œç›´æ¥å‘é€
    if (options.question) {
      this.sendQuickQuestion({ currentTarget: { dataset: { question: options.question } } })
    }
  },

  onShow() {
    // åˆ·æ–°ç”¨æˆ·å­¦ä¹ æ•°æ®
    this.refreshUserData()
  },

  // ==================== Tabåˆ‡æ¢ ====================

  switchTab(e) {
    const tab = e.currentTarget.dataset.tab
    this.setData({ activeTab: tab })

    if (tab === 'courses') {
      this.filterCourses()
    }
  },

  // ==================== AIå¯¹è¯åŠŸèƒ½ ====================

  /**
   * è¾“å…¥æ¡†è¾“å…¥
   */
  onInput(e) {
    this.setData({
      inputText: e.detail.value
    })
  },

  /**
   * æ¸…ç©ºè¾“å…¥
   */
  clearInput() {
    this.setData({ inputText: '' })
  },

  /**
   * å‘é€æ¶ˆæ¯
   */
  async sendMessage() {
    const { inputText } = this.data

    if (!inputText || !inputText.trim()) {
      return
    }

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    this.addMessage('user', inputText.trim())

    // æ¸…ç©ºè¾“å…¥æ¡†
    this.setData({ inputText: '' })

    // æ˜¾ç¤ºAIæ‰“å­—ä¸­
    this.setData({ aiTyping: true })

    // æ¨¡æ‹ŸAIå›å¤ï¼ˆå®é™…åº”è¯¥è°ƒç”¨åç«¯APIï¼‰
    setTimeout(() => {
      this.generateAIResponse(inputText.trim())
    }, 1500)
  },

  /**
   * æ·»åŠ æ¶ˆæ¯åˆ°åˆ—è¡¨
   */
  addMessage(role, content, actionCard = null) {
    const messages = this.data.messages
    const messageId = `msg-${Date.now()}`

    messages.push({
      id: messageId,
      role: role,
      content: content,
      avatar: role === 'user' ? this.data.userAvatar : this.data.aiAvatar,
      time: this.formatTime(new Date()),
      actionCard: actionCard
    })

    this.setData({
      messages: messages,
      scrollToView: messageId
    })
  },

  /**
   * ç”ŸæˆAIå›å¤ï¼ˆæ¨¡æ‹Ÿï¼‰
   */
  generateAIResponse(userMessage) {
    let aiReply = ''
    let actionCard = null

    const msg = userMessage.toLowerCase()

    // æ ¹æ®ç”¨æˆ·é—®é¢˜ç”Ÿæˆä¸åŒå›å¤
    if (msg.includes('å®Œå‹') || msg.includes('å®Œå½¢')) {
      aiReply = 'æˆ‘çœ‹äº†ä½ çš„æ•°æ®ï¼Œå®Œå‹å¡«ç©ºæ­£ç¡®ç‡45%ï¼Œä¸»è¦é—®é¢˜æ˜¯ï¼š\n\n1. é€»è¾‘å…³ç³»è¯æŒæ¡ä¸è¶³ï¼ˆ35%ï¼‰\n2. å›ºå®šæ­é…è®°å¿†ä¸ç‰¢ï¼ˆ40%ï¼‰\n\nå»ºè®®ä½ å…ˆå­¦ä¹ 20ä¸ªå¸¸è§é€»è¾‘å…³ç³»è¯ï¼Œç„¶ååš10é“ä¸“é¡¹ç»ƒä¹ ï¼Œ3å¤©åå¯ä»¥çœ‹åˆ°æ˜æ˜¾æ•ˆæœã€‚'
      actionCard = {
        title: 'å®Œå‹å¡«ç©ºé€»è¾‘è¯ä¸“é¡¹ç»ƒä¹ ',
        description: '20é“é¢˜ï¼Œé¢„è®¡30åˆ†é’Ÿ',
        buttonText: 'å¼€å§‹ç»ƒä¹ ',
        action: 'start_practice',
        params: { type: 'cloze_logic' }
      }
    } else if (msg.includes('å•è¯') || msg.includes('è¯æ±‡') || msg.includes('è®°å¿†')) {
      aiReply = 'è€ƒç ”è‹±è¯­æœ‰6000ä¸ªè¯æ±‡ï¼Œæ¨èä½¿ç”¨è¯ç´ åˆ†ææ³•å­¦ä¹ ï¼š\n\n1. å…ˆå­¦ä¹ 120ä¸ªæ ¸å¿ƒè¯æ ¹\n2. æŒæ¡30ä¸ªå¸¸ç”¨å‰ç¼€å’Œ25ä¸ªåç¼€\n3. é€šè¿‡è¯ç´ æ‹†è§£ç†è§£å•è¯\n\nè¿™æ ·å¯ä»¥å°†1400+å•è¯å…³è”è®°å¿†ï¼Œæ•ˆç‡æå‡5-7å€ï¼'
      actionCard = {
        title: 'å¼€å§‹è¯ç´ å­¦ä¹ ',
        description: 'ä»120ä¸ªæ ¸å¿ƒè¯æ ¹å¼€å§‹',
        buttonText: 'å¼€å§‹å­¦ä¹ ',
        action: 'start_vocabulary',
        params: { type: 'morpheme' }
      }
    } else if (msg.includes('è®¡åˆ’') || msg.includes('è§„åˆ’')) {
      aiReply = 'æ ¹æ®ä½ çš„å½“å‰æ°´å¹³å’Œç›®æ ‡ï¼Œæˆ‘å»ºè®®åˆ¶å®šä¸€ä¸ª15ä¸ªæœˆçš„å­¦ä¹ è®¡åˆ’ï¼š\n\nç¬¬1-3æœˆï¼šè¯ç´ å­¦ä¹ \nç¬¬4-7æœˆï¼šè¯æ±‡+é¢˜å‹å…¥é—¨\nç¬¬8-11æœˆï¼šæ·±åŒ–æå‡\nç¬¬12-15æœˆï¼šå†²åˆºæ¨¡è€ƒ\n\néœ€è¦æˆ‘å¸®ä½ ç”Ÿæˆè¯¦ç»†çš„æ¯æ—¥å­¦ä¹ ä»»åŠ¡å—ï¼Ÿ'
      actionCard = {
        title: 'ç”Ÿæˆä¸ªæ€§åŒ–å­¦ä¹ è®¡åˆ’',
        description: 'åŸºäºAIåˆ†æçš„15ä¸ªæœˆè®¡åˆ’',
        buttonText: 'ç”Ÿæˆè®¡åˆ’',
        action: 'generate_plan',
        params: {}
      }
    } else if (msg.includes('æ•°æ®') || msg.includes('åˆ†æ')) {
      aiReply = 'è®©æˆ‘åˆ†æä¸€ä¸‹ä½ æœ€è¿‘çš„å­¦ä¹ æ•°æ®ï¼š\n\nğŸ“Š æœ¬å‘¨å­¦ä¹ ï¼š\nâ€¢ å®Œæˆé¢˜ç›®ï¼š120é¢˜\nâ€¢ æ­£ç¡®ç‡ï¼š78%ï¼ˆâ†‘5%ï¼‰\nâ€¢ å­¦ä¹ æ—¶é•¿ï¼š180åˆ†é’Ÿ\n\nâš ï¸ è–„å¼±ç‚¹ï¼š\nâ€¢ å®Œå‹å¡«ç©ºé€»è¾‘è¯ï¼ˆ45%ï¼‰\nâ€¢ é˜…è¯»æ¨ç†é¢˜ï¼ˆ40%ï¼‰\n\nğŸ’ª å»ºè®®ä¼˜å…ˆå¼ºåŒ–è¿™ä¸¤ä¸ªè–„å¼±ç‚¹ã€‚'
      actionCard = {
        title: 'æŸ¥çœ‹å®Œæ•´å­¦ä¹ æŠ¥å‘Š',
        description: 'è¯¦ç»†çš„æ•°æ®åˆ†æå’Œå»ºè®®',
        buttonText: 'æŸ¥çœ‹æŠ¥å‘Š',
        action: 'view_report',
        params: {}
      }
    } else {
      aiReply = 'æˆ‘æ˜¯ä½ çš„AIå­¦ä¹ ä¼™ä¼´ï¼Œæˆ‘å¯ä»¥å¸®ä½ ï¼š\n\nğŸ“š å­¦ä¹ è¯Šæ–­ - åˆ†æä½ çš„å­¦ä¹ æ•°æ®\nâ“ é¢˜ç›®ç­”ç–‘ - è§£ç­”ç–‘éš¾é—®é¢˜\nğŸ“– è¯æ±‡è§£æ - è¯ç´ æ‹†è§£è®²è§£\nğŸ“… åˆ¶å®šè®¡åˆ’ - ä¸ªæ€§åŒ–å­¦ä¹ è§„åˆ’\nğŸ’¡ å­¦ä¹ å»ºè®® - æ ¹æ®æ•°æ®ç»™å»ºè®®\nğŸ˜Š å¿ƒç†è¾…å¯¼ - ç¼“è§£ç„¦è™‘å‹åŠ›\n\nä½ å¯ä»¥ç‚¹å‡»ä¸‹æ–¹å¿«æ·åŠŸèƒ½ï¼Œæˆ–è€…ç›´æ¥é—®æˆ‘é—®é¢˜ï¼'
    }

    this.setData({ aiTyping: false })
    this.addMessage('ai', aiReply, actionCard)
  },

  /**
   * å‘é€å¿«é€Ÿé—®é¢˜
   */
  sendQuickQuestion(e) {
    const question = e.currentTarget.dataset.question
    this.setData({ inputText: question })
    this.sendMessage()
  },

  /**
   * å‘é€å¿«æ·æ“ä½œ
   */
  sendQuickAction(e) {
    const action = e.currentTarget.dataset.action

    const actionMessages = {
      'diagnose': 'å¸®æˆ‘è¯Šæ–­ä¸€ä¸‹æœ€è¿‘çš„å­¦ä¹ æƒ…å†µ',
      'question_help': 'æˆ‘æœ‰ä¸€é“é¢˜ç›®ä¸ä¼šåš',
      'vocabulary_help': 'å¸®æˆ‘åˆ†æä¸€ä¸ªå•è¯',
      'make_plan': 'å¸®æˆ‘åˆ¶å®šä¸€ä¸ªå­¦ä¹ è®¡åˆ’',
      'advice': 'ç»™æˆ‘ä¸€äº›å­¦ä¹ å»ºè®®',
      'psychology': 'æˆ‘æœ€è¿‘å­¦ä¹ å‹åŠ›å¾ˆå¤§'
    }

    const message = actionMessages[action] || 'ä½ å¥½'
    this.setData({ inputText: message })
    this.sendMessage()
  },

  /**
   * å¤„ç†æ“ä½œå¡ç‰‡ç‚¹å‡»
   */
  handleActionCard(e) {
    const { action, params } = e.currentTarget.dataset

    switch(action) {
      case 'start_practice':
        wx.navigateTo({
          url: `/pages/practice/practice?type=${params.type}`
        })
        break
      case 'start_vocabulary':
        wx.showToast({
          title: 'å•è¯å­¦ä¹ é¡µé¢å¼€å‘ä¸­',
          icon: 'none'
        })
        break
      case 'generate_plan':
        wx.showToast({
          title: 'å­¦ä¹ è®¡åˆ’ç”ŸæˆåŠŸèƒ½å¼€å‘ä¸­',
          icon: 'none'
        })
        break
      case 'view_report':
        wx.switchTab({
          url: '/pages/profile/profile'
        })
        break
    }
  },

  /**
   * æ ¼å¼åŒ–æ—¶é—´
   */
  formatTime(date) {
    const hour = date.getHours()
    const minute = date.getMinutes()
    return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`
  },

  /**
   * åˆ·æ–°ç”¨æˆ·æ•°æ®
   */
  refreshUserData() {
    // TODO: ä»äº‘æ•°æ®åº“è·å–ç”¨æˆ·å­¦ä¹ æ•°æ®
    // ç”¨äºAIåˆ†æå’Œå»ºè®®
  },

  // ==================== è¯¾ç¨‹åŠŸèƒ½ ====================

  /**
   * é€‰æ‹©è¯¾ç¨‹åˆ†ç±»
   */
  selectCategory(e) {
    const id = e.currentTarget.dataset.id
    this.setData({ selectedCategory: id })
    this.filterCourses()
  },

  /**
   * ç­›é€‰è¯¾ç¨‹
   */
  filterCourses() {
    const { courses, selectedCategory } = this.data

    if (selectedCategory === 'all') {
      this.setData({ filteredCourses: courses })
    } else {
      const filtered = courses.filter(c => c.category === selectedCategory)
      this.setData({ filteredCourses: filtered })
    }
  },

  /**
   * è·³è½¬åˆ°è¯¾ç¨‹è¯¦æƒ…
   */
  goToCourseDetail(e) {
    const id = e.currentTarget.dataset.id

    wx.showToast({
      title: 'è¯¾ç¨‹è¯¦æƒ…é¡µé¢å¼€å‘ä¸­',
      icon: 'none'
    })

    // TODO: è·³è½¬åˆ°è¯¾ç¨‹è¯¦æƒ…
    // wx.navigateTo({
    //   url: `/pages/course-detail/course-detail?id=${id}`
    // })
  },

  /**
   * å¼€å§‹/ç»§ç»­å­¦ä¹ è¯¾ç¨‹
   */
  startCourse(e) {
    const id = e.currentTarget.dataset.id
    const course = this.data.courses.find(c => c.id === id)

    if (!course) {return}

    wx.showToast({
      title: course.progress > 0 ? 'ç»§ç»­å­¦ä¹ ...' : 'å¼€å§‹å­¦ä¹ ...',
      icon: 'loading',
      duration: 1000
    })

    setTimeout(() => {
      wx.showToast({
        title: 'è¯¾ç¨‹æ’­æ”¾åŠŸèƒ½å¼€å‘ä¸­',
        icon: 'none'
      })
    }, 1000)

    // TODO: è·³è½¬åˆ°è¯¾ç¨‹æ’­æ”¾é¡µ
    // wx.navigateTo({
    //   url: `/pages/course-player/course-player?id=${id}`
    // })
  }
})

