# Database Rules - 数据库操作规则
#
# Task: ARCHITECTURE-SIMPLIFICATION (Task 1.3)
# Requirements: REQ-1 (规则为一等公民), REQ-5.3 (数据库操作触发人工复核)

version: "1.0.0"
ruleset_id: ruleset_database
ruleset_name: 数据库操作规则集
last_updated: "2025-12-17"

rules:
  # SQL 注入防护
  - id: DBA-001
    category: database
    description: "禁止使用字符串拼接构造 SQL 语句"
    human_description: "这段代码可能会让攻击者执行任意数据库操作，非常危险"
    severity: mandatory
    detector: grep
    pattern: "execute.*\\+"
    fix_suggestion: "使用参数化查询: cursor.execute('SELECT * FROM users WHERE id = ?', (user_id,))"
    requirement_ids:
      - "REQ-DBA-001"

  - id: DBA-002
    category: database
    description: "禁止使用 format() 或 f-string 构造 SQL"
    human_description: "这段代码可能会让攻击者执行任意数据库操作，非常危险"
    severity: mandatory
    detector: grep
    pattern: "\\.format.*SELECT|f[\"'].*SELECT"
    fix_suggestion: "使用参数化查询，不要用字符串格式化"
    requirement_ids:
      - "REQ-DBA-001"

  # 连接管理
  - id: DBA-003
    category: database
    description: "数据库连接必须使用 with 语句或显式关闭"
    human_description: "这段代码可能会导致数据库连接泄漏，最终耗尽连接池"
    severity: mandatory
    detector: grep
    pattern: "connect\\s*\\("
    fix_suggestion: "使用 with connection: 或在 finally 中关闭连接"
    requirement_ids:
      - "REQ-DBA-001"

  - id: DBA-004
    category: database
    description: "数据库连接应使用连接池"
    human_description: "频繁创建数据库连接会影响性能，建议使用连接池"
    severity: recommended
    detector: manual
    fix_suggestion: "使用 SQLAlchemy 连接池或 psycopg2.pool"
    requirement_ids:
      - "REQ-DBA-002"

  # 事务管理
  - id: DBA-005
    category: database
    description: "数据修改操作应在事务中执行"
    human_description: "这段代码修改数据但没有使用事务，出错时可能导致数据不一致"
    severity: mandatory
    detector: grep
    pattern: "INSERT|UPDATE|DELETE"
    fix_suggestion: "使用事务: with connection.begin(): ..."
    requirement_ids:
      - "REQ-DBA-002"

  - id: DBA-006
    category: database
    description: "事务必须有回滚机制"
    human_description: "这段代码的事务出错时可能无法正确回滚"
    severity: mandatory
    detector: grep
    pattern: "commit\\s*\\(\\)"
    fix_suggestion: "在 except 块中添加 rollback()"
    requirement_ids:
      - "REQ-DBA-002"

  # 敏感数据
  - id: DBA-007
    category: database
    description: "禁止在日志中输出完整 SQL 语句"
    human_description: "日志中可能会记录用户的敏感数据"
    severity: mandatory
    detector: grep
    pattern: "log.*sql|log.*query"
    fix_suggestion: "只记录 SQL 模板，不记录参数值"
    requirement_ids:
      - "REQ-DBA-001"

  - id: DBA-008
    category: database
    description: "数据库密码不应硬编码"
    human_description: "代码中直接写了数据库密码，这很危险"
    severity: mandatory
    detector: grep
    pattern: "connect.*password\\s*=\\s*[\"'][^\"']+[\"']"
    fix_suggestion: "使用环境变量: os.environ['DB_PASSWORD']"
    requirement_ids:
      - "REQ-DBA-001"
