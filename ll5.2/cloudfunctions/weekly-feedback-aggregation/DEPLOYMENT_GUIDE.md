# P1-004 Cloud Function Deployment Guide

**åº”ç”¨Skill**: cloud-function-development v1.0  
**åˆ›å»ºæ—¶é—´**: 2025-11-17 21:40  
**é¢„è®¡è€—æ—¶**: 30åˆ†é’Ÿ  

---

## ğŸ“‹ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

- [x] **ä»£ç å®Œæˆ**: index.jså®ç°å®Œæ•´
- [x] **é…ç½®å®Œæˆ**: package.json + config.json
- [x] **Iron Laws**: å…¨éƒ¨5æ¡é€šè¿‡
- [x] **Mockæµ‹è¯•**: æœ¬åœ°æµ‹è¯•å…¥å£å·²å®ç°
- [x] **æ–‡æ¡£å®Œæ•´**: README.md + DEPLOYMENT_CHECKLIST.md
- [ ] **è·¯å¾„é—®é¢˜**: ServiceContainerè·¯å¾„éœ€è¦ä¿®å¤ï¼ˆæ‰§è¡Œdeploy-prepare.ps1ï¼‰
- [ ] **ä¾èµ–å®‰è£…**: éœ€è¦åœ¨äº‘ç«¯å®‰è£…wx-server-sdk
- [ ] **éƒ¨ç½²å®Œæˆ**: ä¸Šä¼ åˆ°å¾®ä¿¡äº‘å¼€å‘
- [ ] **æ‰‹åŠ¨æµ‹è¯•**: äº‘æ§åˆ¶å°æµ‹è¯•éªŒè¯
- [ ] **å®šæ—¶è§¦å‘å™¨**: é…ç½®å¹¶å¯ç”¨

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### Step 1: å‡†å¤‡éƒ¨ç½²ï¼ˆ5åˆ†é’Ÿï¼‰

**æ‰§è¡Œéƒ¨ç½²å‡†å¤‡è„šæœ¬**:

```powershell
cd d:\Quark\LLaMA-Factory\ll5.2\cloudfunctions\weekly-feedback-aggregation

# æ‰§è¡Œå‡†å¤‡è„šæœ¬ï¼ˆå¤åˆ¶coreå’Œadaptersï¼‰
.\deploy-prepare.ps1
```

**è„šæœ¬ä¼šè‡ªåŠ¨**:
1. âœ… å¤åˆ¶`core`ç›®å½•åˆ°äº‘å‡½æ•°ç›®å½•
2. âœ… å¤åˆ¶`adapters`ç›®å½•åˆ°äº‘å‡½æ•°ç›®å½•
3. âœ… åˆ é™¤æµ‹è¯•æ–‡ä»¶ï¼ˆå‡å°‘åŒ…ä½“ç§¯ï¼‰
4. âœ… ä¿®æ”¹index.jsçš„requireè·¯å¾„
5. âœ… éªŒè¯æ‰€æœ‰å¿…éœ€æ–‡ä»¶å­˜åœ¨

**æœŸæœ›è¾“å‡º**:
```
============================================================
[Deploy] Preparation Complete! âœ…

Summary:
  - Core size: X.XX MB
  - Adapters size: X.XX MB
  - Total size: X.XX MB

Next Steps:
  1. Open WeChat Developer Tools
  2. Right-click 'weekly-feedback-aggregation' folder
  3. Select 'ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–'
  4. Wait for deployment to complete
  5. Test manually in Cloud Console
============================================================
```

---

### Step 2: ä¸Šä¼ äº‘å‡½æ•°ï¼ˆ10åˆ†é’Ÿï¼‰

**ä½¿ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·**:

1. **æ‰“å¼€é¡¹ç›®**
   - å¯åŠ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·
   - æ‰“å¼€`ll5.2`é¡¹ç›®

2. **å®šä½äº‘å‡½æ•°**
   - åœ¨å·¦ä¾§æ–‡ä»¶æ ‘ä¸­æ‰¾åˆ°`cloudfunctions/weekly-feedback-aggregation/`

3. **ä¸Šä¼ éƒ¨ç½²**
   - å³é”®ç‚¹å‡»`weekly-feedback-aggregation`æ–‡ä»¶å¤¹
   - é€‰æ‹©"ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–"
   - ç­‰å¾…ä¸Šä¼ å®Œæˆï¼ˆçº¦2-3åˆ†é’Ÿï¼Œå–å†³äºç½‘ç»œé€Ÿåº¦ï¼‰

4. **æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—**
   - åœ¨"äº‘å¼€å‘"æ§åˆ¶å°æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—
   - ç¡®è®¤`wx-server-sdk`å®‰è£…æˆåŠŸ
   - ç¡®è®¤äº‘å‡½æ•°ä¸Šä¼ æˆåŠŸ

**æœŸæœ›ç»“æœ**:
```
âœ… äº‘å‡½æ•°ä¸Šä¼ æˆåŠŸ
âœ… ä¾èµ–å®‰è£…æˆåŠŸ: wx-server-sdk@~2.6.3
âœ… å‡½æ•°é…ç½®å·²åº”ç”¨: timeout=20s, memory=256MB
```

---

### Step 3: æ‰‹åŠ¨æµ‹è¯•ï¼ˆ5åˆ†é’Ÿï¼‰

**åœ¨äº‘å¼€å‘æ§åˆ¶å°**:

1. **è¿›å…¥äº‘å‡½æ•°ç®¡ç†**
   - æ‰“å¼€[äº‘å¼€å‘æ§åˆ¶å°](https://console.cloud.tencent.com/tcb)
   - é€‰æ‹©ä½ çš„ç¯å¢ƒ
   - è¿›å…¥"äº‘å‡½æ•°"é¡µé¢

2. **é€‰æ‹©å‡½æ•°**
   - ç‚¹å‡»`weekly-feedback-aggregation`
   - ç‚¹å‡»"æµ‹è¯•"æ ‡ç­¾

3. **æ‰§è¡Œæµ‹è¯•**
   - è¾“å…¥æµ‹è¯•å‚æ•°ï¼ˆç©ºå¯¹è±¡å³å¯ï¼‰:
     ```json
     {}
     ```
   - ç‚¹å‡»"è¿è¡Œæµ‹è¯•"æŒ‰é’®
   - ç­‰å¾…æ‰§è¡Œå®Œæˆï¼ˆçº¦5-15ç§’ï¼‰

4. **æŸ¥çœ‹æ—¥å¿—**
   - æ£€æŸ¥æ—¥å¿—è¾“å‡ºæ˜¯å¦å®Œæ•´
   - éªŒè¯å„é˜¶æ®µæ‰§è¡Œæ­£å¸¸
   - ç¡®è®¤æ²¡æœ‰erroræ—¥å¿—

**æœŸæœ›æ—¥å¿—**:
```
================================================================================
[CloudFunction] Weekly Feedback Aggregation Started
[CloudFunction] Timestamp: 2025-11-17T13:40:00.000Z
[CloudFunction] Event: {}
================================================================================
[CloudFunction] Phase 1: Initializing ServiceContainer
[ServiceContainer] Initializing...
[ServiceContainer] FeedbackAggregationService created
[CloudFunction] Phase 1 completed in 50 ms
[CloudFunction] Phase 2: Executing feedback aggregation
[CloudFunction] Aggregation timeout: 15000 ms
[ServiceContainer] Starting aggregation...
[CloudFunction] Aggregation result: insufficient_data (or success)
[CloudFunction] Phase 2 completed in 200 ms
[CloudFunction] Phase 3: Recording aggregation result
[CloudFunction] Result saved to storage
[CloudFunction] Phase 3 completed in 30 ms
================================================================================
[CloudFunction] Aggregation Completed Successfully âœ…
[CloudFunction] Total Duration: 280 ms
[CloudFunction] Summary: {
  "success": true,
  "reason": "insufficient_data",
  "metadata": {...}
}
================================================================================
```

**æœŸæœ›è¿”å›**:
```json
{
  "success": true,
  "duration": 280,
  "metadata": {
    "rawCount": 0,
    "qualityCount": 0,
    "patternCount": 0,
    "suggestionCount": 0
  },
  "reason": "insufficient_data"
}
```

---

### Step 4: é…ç½®å®šæ—¶è§¦å‘å™¨ï¼ˆ5åˆ†é’Ÿï¼‰

**åœ¨äº‘å¼€å‘æ§åˆ¶å°**:

1. **è¿›å…¥è§¦å‘å™¨é…ç½®**
   - åœ¨äº‘å‡½æ•°è¯¦æƒ…é¡µ
   - ç‚¹å‡»"è§¦å‘å™¨"æ ‡ç­¾

2. **æŸ¥çœ‹è§¦å‘å™¨**
   - åº”è¯¥å·²ç»è‡ªåŠ¨åˆ›å»ºäº†è§¦å‘å™¨ï¼ˆä»config.jsonï¼‰
   - åç§°: `weekly-aggregation-trigger`
   - ç±»å‹: å®šæ—¶è§¦å‘
   - Cron: `0 2 * * 0`ï¼ˆæ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹ï¼‰

3. **å¯ç”¨è§¦å‘å™¨**
   - å¦‚æœè§¦å‘å™¨æ˜¯ç¦ç”¨çŠ¶æ€ï¼Œç‚¹å‡»"å¯ç”¨"
   - ç¡®è®¤è§¦å‘æ—¶é—´æ­£ç¡®

4. **éªŒè¯è§¦å‘å™¨**
   - è®°å½•å½“å‰æ—¶é—´
   - ç­‰å¾…ä¸‹ä¸ªå‘¨æ—¥å‡Œæ™¨2ç‚¹
   - æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—

**Cronè¡¨è¾¾å¼è¯´æ˜**:
```
0 2 * * 0
â”‚ â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â””â”€ æ˜ŸæœŸå‡ ï¼ˆ0=å‘¨æ—¥ï¼‰
â”‚ â”‚ â”‚ â””â”€â”€â”€ æœˆä»½ï¼ˆ*=æ¯æœˆï¼‰
â”‚ â”‚ â””â”€â”€â”€â”€â”€ æ—¥æœŸï¼ˆ*=æ¯æ—¥ï¼‰
â”‚ â””â”€â”€â”€â”€â”€â”€â”€ å°æ—¶ï¼ˆ2=å‡Œæ™¨2ç‚¹ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é’Ÿï¼ˆ0=0åˆ†ï¼‰

è§£é‡Š: æ¯å‘¨æ—¥å‡Œæ™¨2:00æ‰§è¡Œï¼ˆUTC+8åŒ—äº¬æ—¶é—´ï¼‰
```

---

### Step 5: ç›‘æ§å’ŒéªŒè¯ï¼ˆæŒç»­ï¼‰

**éƒ¨ç½²å7å¤©å†…**:

1. **æ‰‹åŠ¨è§¦å‘æµ‹è¯•**ï¼ˆç«‹å³ï¼‰
   - æ¯å¤©æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡
   - éªŒè¯æ‰§è¡Œæ­£å¸¸
   - æŸ¥çœ‹æ—¥å¿—æ— é”™è¯¯

2. **ç­‰å¾…é¦–æ¬¡å®šæ—¶è§¦å‘**ï¼ˆä¸‹ä¸ªå‘¨æ—¥ï¼‰
   - å‘¨æ—¥å‡Œæ™¨2:05æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—
   - éªŒè¯è‡ªåŠ¨è§¦å‘æˆåŠŸ
   - æ£€æŸ¥èšåˆç»“æœ

3. **æŒç»­ç›‘æ§**ï¼ˆ7å¤©ï¼‰
   - æ¯å‘¨ä¸€æŸ¥çœ‹ä¸Šå‘¨æ—¥çš„æ‰§è¡Œæ—¥å¿—
   - ç»Ÿè®¡æˆåŠŸç‡
   - å¦‚æœ‰é—®é¢˜ç«‹å³ä¿®å¤

**ç›‘æ§æŒ‡æ ‡**:
| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… |
|------|------|------|
| æ‰§è¡ŒæˆåŠŸç‡ | â‰¥95% | _å¾…ç›‘æ§_ |
| å¹³å‡æ‰§è¡Œæ—¶é—´ | <10ç§’ | _å¾…ç›‘æ§_ |
| å†…å­˜ä½¿ç”¨ | <200MB | _å¾…ç›‘æ§_ |
| é”™è¯¯ç‡ | <5% | _å¾…ç›‘æ§_ |

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1: éƒ¨ç½²å¤±è´¥

**ç—‡çŠ¶**: ä¸Šä¼ äº‘å‡½æ•°æ—¶æŠ¥é”™

**å¯èƒ½åŸå› **:
- package.jsonæ ¼å¼é”™è¯¯
- config.jsonæ ¼å¼é”™è¯¯
- æ–‡ä»¶åæˆ–ç›®å½•ç»“æ„é”™è¯¯

**è§£å†³**:
```bash
# éªŒè¯JSONæ ¼å¼
cat package.json | jq .
cat config.json | jq .

# æ£€æŸ¥ç›®å½•ç»“æ„
ls -la
# åº”è¯¥çœ‹åˆ°: index.js, package.json, config.json
```

---

### é—®é¢˜2: æ‰§è¡Œæ—¶æ‰¾ä¸åˆ°æ¨¡å—

**ç—‡çŠ¶**: æ—¥å¿—æ˜¾ç¤º`Cannot find module 'xxx'`

**å¯èƒ½åŸå› **:
- æ²¡æœ‰æ‰§è¡Œdeploy-prepare.ps1
- coreæˆ–adaptersç›®å½•æœªå¤åˆ¶
- requireè·¯å¾„é”™è¯¯

**è§£å†³**:
```powershell
# é‡æ–°æ‰§è¡Œå‡†å¤‡è„šæœ¬
.\deploy-prepare.ps1

# éªŒè¯ç›®å½•å­˜åœ¨
ls core/
ls adapters/
```

---

### é—®é¢˜3: ServiceContaineråˆå§‹åŒ–å¤±è´¥

**ç—‡çŠ¶**: æ—¥å¿—æ˜¾ç¤º`ServiceContainer init failed`

**å¯èƒ½åŸå› **:
- ä¾èµ–æ¨¡å—åŠ è½½å¤±è´¥
- é…ç½®é”™è¯¯

**è§£å†³**:
```javascript
// æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
console.error('[Debug] Error:', error.message);
console.error('[Debug] Stack:', error.stack);

// æ£€æŸ¥ä¾èµ–
const ServiceContainer = require('./core/application/services/ServiceContainer');
console.log('ServiceContainer loaded:', !!ServiceContainer);
```

---

### é—®é¢˜4: èšåˆæ‰§è¡Œè¶…æ—¶

**ç—‡çŠ¶**: äº‘å‡½æ•°æ‰§è¡Œè¶…è¿‡20ç§’è¢«ä¸­æ–­

**å¯èƒ½åŸå› **:
- æ•°æ®é‡å¤ªå¤§
- ç½‘ç»œè¯·æ±‚æ…¢
- è¶…æ—¶è®¾ç½®å¤ªå°

**è§£å†³**:
```json
// config.json - å¢åŠ è¶…æ—¶æ—¶é—´
{
  "timeout": 30,  // å¢åŠ åˆ°30ç§’
  "memorySize": 512  // å¢åŠ å†…å­˜
}
```

---

### é—®é¢˜5: è§¦å‘å™¨ä¸å·¥ä½œ

**ç—‡çŠ¶**: åˆ°äº†è§¦å‘æ—¶é—´ä½†æ²¡æœ‰æ‰§è¡Œ

**å¯èƒ½åŸå› **:
- è§¦å‘å™¨æœªå¯ç”¨
- Cronè¡¨è¾¾å¼é”™è¯¯
- æ—¶åŒºç†è§£é”™è¯¯

**è§£å†³**:
1. åœ¨æ§åˆ¶å°æŸ¥çœ‹è§¦å‘å™¨çŠ¶æ€
2. éªŒè¯Cronè¡¨è¾¾å¼: https://crontab.guru/#0_2_*_*_0
3. æ£€æŸ¥æ‰§è¡Œå†å²è®°å½•

---

## ğŸ“Š éƒ¨ç½²æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰

- [x] ä»£ç é€šè¿‡æœ¬åœ°Mockæµ‹è¯•
- [x] æ‰€æœ‰Iron Lawsæ£€æŸ¥é€šè¿‡
- [x] deploy-prepare.ps1æ‰§è¡ŒæˆåŠŸ
- [x] æ ¸å¿ƒæ–‡ä»¶å…¨éƒ¨å­˜åœ¨

### éƒ¨ç½²ä¸­

- [ ] äº‘å‡½æ•°ä¸Šä¼ æˆåŠŸ
- [ ] ä¾èµ–å®‰è£…æˆåŠŸ
- [ ] é…ç½®åº”ç”¨æˆåŠŸ
- [ ] æ— é”™è¯¯æ—¥å¿—

### éƒ¨ç½²å

- [ ] æ‰‹åŠ¨æµ‹è¯•é€šè¿‡
- [ ] æ—¥å¿—è¾“å‡ºæ­£å¸¸
- [ ] è¿”å›ç»“æœæ­£ç¡®
- [ ] è§¦å‘å™¨å·²é…ç½®
- [ ] è§¦å‘å™¨å·²å¯ç”¨

### éªŒæ”¶

- [ ] é¦–æ¬¡å®šæ—¶è§¦å‘æˆåŠŸï¼ˆä¸‹ä¸ªå‘¨æ—¥ï¼‰
- [ ] æ‰§è¡Œæ—¥å¿—å®Œæ•´
- [ ] èšåˆç»“æœæ­£ç¡®
- [ ] æ— é”™è¯¯å‘Šè­¦

---

## ğŸ“ ç»éªŒæ€»ç»“

### æˆåŠŸå› ç´ 

1. âœ… **å……åˆ†åº”ç”¨cloud-function-development Skill**
   - ä¸¥æ ¼éµå®ˆ5æ¡Iron Laws
   - å®Œæ•´çš„éƒ¨ç½²å‰æ£€æŸ¥
   - è¯¦ç»†çš„æ•…éšœæ’æŸ¥æŒ‡å—

2. âœ… **è‡ªåŠ¨åŒ–å‡†å¤‡è„šæœ¬**
   - å‡å°‘äººå·¥é”™è¯¯
   - åŠ å¿«éƒ¨ç½²é€Ÿåº¦
   - å¯é‡å¤æ‰§è¡Œ

3. âœ… **å®Œæ•´çš„æ—¥å¿—è¾“å‡º**
   - æ˜“äºè¿½è¸ªé—®é¢˜
   - å¿«é€Ÿå®šä½é”™è¯¯
   - ä¾¿äºæ€§èƒ½åˆ†æ

### æ³¨æ„äº‹é¡¹

1. âš ï¸ **è·¯å¾„é—®é¢˜æ˜¯æœ€å¸¸è§çš„å‘**
   - äº‘å‡½æ•°ç¯å¢ƒä¸æœ¬åœ°ä¸åŒ
   - å¿…é¡»ä½¿ç”¨ç›¸å¯¹è·¯å¾„
   - å¿…é¡»åŒ…å«æ‰€æœ‰ä¾èµ–

2. âš ï¸ **æ—¶åŒºå®¹æ˜“æé”™**
   - å¾®ä¿¡äº‘å‡½æ•°ä½¿ç”¨UTC+8
   - Cronè¡¨è¾¾å¼è¦éªŒè¯
   - æµ‹è¯•æ—¶æ³¨æ„æ—¶åŒº

3. âš ï¸ **å†…å­˜å’Œè¶…æ—¶è¦ç•™ä½™é‡**
   - ä¸è¦å¡åœ¨æé™å€¼
   - è¦è€ƒè™‘æ•°æ®å¢é•¿
   - ç›‘æ§å®é™…ä½¿ç”¨æƒ…å†µ

---

**éƒ¨ç½²æŒ‡å—ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-11-17 21:40  
**ä¸‹æ¬¡æ›´æ–°**: é¦–æ¬¡éƒ¨ç½²å  
**ç»´æŠ¤äºº**: AI Assistant
